<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>排班表</title>
    <link rel="stylesheet" href="../assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="../assets/css/loading.css">
    <link rel="stylesheet" href="../assets/css/google.font.css">
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/lib/cal.css">
    <style>
        .space{height: 0;}
        .modal.right .modal-dialog {
            position: fixed;
            margin: auto;
            width: 320px;
            height: 100%;
            -webkit-transform: translate3d(0%, 0, 0);
                -ms-transform: translate3d(0%, 0, 0);
                -o-transform: translate3d(0%, 0, 0);
                    transform: translate3d(0%, 0, 0);
        }

        .modal.right .modal-content {
            height: 100%;
            overflow-y: auto;
        }
        
        .modal.right .modal-body {
            padding: 15px 15px 80px;
        }

        .modal.right .modal-header .close {
            padding: 1.5rem 1rem 0rem;
            margin: -1rem -1rem -1rem auto;
        }

        /*Right*/
        .modal.right.fade .modal-dialog {
            right: 0;
            -webkit-transition: opacity 0.3s linear, right 0.3s ease-out;
            -moz-transition: opacity 0.3s linear, right 0.3s ease-out;
                -o-transition: opacity 0.3s linear, right 0.3s ease-out;
                    transition: opacity 0.3s linear, right 0.3s ease-out;
        }
        
        .modal.right.fade.in .modal-dialog {
            right: 0;
        }

        /* ----- MODAL STYLE ----- */
        .modal-content {
            border-radius: 0;
            border: none;
        }

        .modal-header {
            border-bottom-color: #EEEEEE;
            background-color: #FAFAFA;
        }
    </style>
</head>
<body>
    <div class="loading-wrapper">
        <svg class="loading"><rect></rect></svg>
    </div>
    <div id='app'>
        <div class="wrapper"  >
            <!-- Sidebar -->
            <nav id="sidebar">
                <ul class="list-unstyled components">
                    <p>樂薪考勤系統 - <span v-text="user.clinic_name"></span></p>
                    <li><a href="./assistant.html">診所管理</a></li>
                    <li><a href="./announce.html">公告管理</a></li>
                    <li><a href="./employee.html">員工資料</a></li>
                    <li><a href="./closed_date.html">休診設定</a></li>
                    <li><a href="./position.html">崗位設定</a></li>
                    <li><a href="./shift_setting.html">班別設定</a></li>
                    <li v-show="user.right > 2"><a href="./salary_item.html">薪項名稱設定</a></li>
                    <li v-show="user.right > 2"><a href="./basic_salary.html">基本薪資設定</a></li></a></li>
                    <li class="active"><a href="./new_shift.html">新排班表</a></li>
                    <li><a href="./shift_record.html">打卡明細</a></li>
                    <li ><a href="./attendance_overtime.html">稽核明細</a></li>
                    <li><a href="./attendance_record.html">出勤明細</a></li>
                    <li><a href="./attendance_statistic.html">出勤統計表</a></li>
                    <li v-show="user.right > 2"><a href="./salary_calculation.html">每月薪資明細表</a></li>
                </ul>
            </nav>

            <!-- Page Content -->
            <div id="content">
                <nav class="navbar navbar-expand-lg navbar-light bg-light">
                    <div class="container-fluid">

                        <button type="button" id="sidebarCollapse" class="navbar-btn">
                            <span></span>
                            <span></span>
                            <span></span>
                        </button>
                        <button class="btn btn-dark d-inline-block d-lg-none ml-auto" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                            <i class="fas fa-align-justify"></i>
                        </button>

                        <div class="collapse navbar-collapse" id="navbarSupportedContent">
                            <ul class="nav navbar-nav ml-auto">
                                <li class="nav-item" style="margin: auto;">
                                    <img width="25" height="25" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAABmJLR0QA/wD/AP+gvaeTAAACqklEQVRoge3Zy29NURTH8U/JNdGWgTCqBBOPxGtATEww8aom+hcYif/AY0oYMmLolRYzM48ZkWAiEdqiAxLvRrRGFa3Bvk33PbTncU+dRu43Wcm+95y19m+du8/aj0uLFi3KpIZeXMcAftRtANfq12qVqUuhB68wmWKvcKgijX9lAc5KF560M3XfykmK/4jj2ITFdduME/VrySQqpUejoD60z3J/B/oTPt1zrHFGFmkc831oy+DXhhuR35CKXuxejcNmtiefpAOfIv/DRUU08xL1RO3zQrnMyhguRJ8rqUqDpp/gxgL+myP/gRJ1ZWYsEpBn+EzRHvmPFRVRZR2O+54oI0he3kft1QX8Y58PRUU0k8DTqH2ggH/s86QJHYVJltGOHL6d+KyEMtoMNY0TWb/sE9lN82AiI9TveFlww+y/RKdG8RM4OMcaUzmjMYlPOIktQqlsr7dPaRw2kzhdgd4/WODPJNJsQhA/L5bTU3QL4zlN/JB5MGxmoiZUlKt4KcywY3iBK/Vr83ZL2aLF/0wXbmFU/tOHvDYqTHZdZYof+QfCkzZSVhK3KhA/ZTfLSCAeNtvKCJjC9qi/72k3Z1k9Tua8vwwy95llLRJv9/7FLJqrjywJjETtVfm0FCLX9jRLAs+i9u58WgqxJ2pfLCPgUdMv1VssKSPoDCzBu6i/PbPfno3FiaAPFDsHSqMdD6N+HmNhWcH34lcU/DV2lhW8Hut1FH8cW0uMD44JFSneVd3BPsWqUw37cTcR96ccpxR563o3LmF54vtR3MMjYfPyBl+FzUybMDyWYQ3WY4dQEDoTcb7gCG7n1JWL5cLualx5S4ZxXMaKuRSeZCXOYbgJ4cPCX1SFF21lLQ3WYRc2YK2Q3FLT1eoHvglleBDPcV9Fx+otWvxP/AYbWExd//xgHAAAAABJRU5ErkJggg=="/>
                                    {{user.name ? user.name : user.account_number}}
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="#" @click="logout()">登出</a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </nav>
                <div>
                    <div class="row">
                        <div class="col-12 col-md-4">
                            <!-- 控制月份  -->
                            <div class="input-group mb-3">
                                <input type="month" class="form-control" v-model="month.month" id="month">
                                <!-- <div class="input-group-append">
                                    <button class="btn btn-outline-secondary" type="button" @click="" >確認</button>
                                </div> -->
                            </div>
                        </div>
                    </div>
                    
                    
                    <!--  -->
                    <p>
                        <button class="btn btn-primary" aria-expanded="false" data-toggle="collapse" data-target="#addShift">新增排班</button>
                        <button class="btn btn-primary" aria-expanded="false" data-toggle="collapse" data-target="#editShift">編輯排班</button>
                        <button class="btn btn-primary" data-toggle="modal" data-target="#copyModal">複製排班</button>
                        <button class="btn btn-primary" @click="printPDF">列印排班</button>
                        <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#statistic" @click="sortTable()">統計</button>
                        
                    </p>
                    <div id="coll">
                        <div class="row">
                            <div class="col-12">
                                <div class="collapse" id="addShift">
                                <div class="card card-body">
                                    <h5>{{month.startDay}} ~ {{month.endDay}}(第{{month.week}}週)<span><button class="btn btn-outline-secondary" id="previousWeek" @click="previousWeek">&lt;</button><button class="btn btn-outline-secondary" id="nextWeek" @click="nextWeek">&gt;</button></span></h5>
                                    <div class="addForm">
                                        <table class="table table-bordered">
                                            <thead>
                                                <tr><th>員工</th><th v-for="d in form.data">{{d.date}} {{ d.day }}</th></tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td>
                                                        <select class="form-control" v-model="form.employee_id" @change="selectAddData()">
                                                            <option value="0">請選擇</option>
                                                            <option v-for="e in employee_not_in_shift" :value="e.employee_id">{{e.name}}</option>
                                                        </select>
                                                    </td>
                                                    <td v-for="(d,index) in form.data">
                                                        <select class="form-control" v-model="form.data[index].shift.shift_id" @change="changeShift(index)" :disabled="checkClosedDate(d.date)">
                                                            <option value="0">休假</option>
                                                            <option v-for="s in shift" :value="s.shift_id">{{s.shift_name}}</option>
                                                        </select>
                                                        <select class="form-control" v-model="form.data[index].position.position_id" @change="changePosition(index)" :disabled="checkClosedDate(d.date)">
                                                            <option value="0">請選擇</option>
                                                            <option v-for="p in position" :value="p.position_id">{{p.name}}</option>
                                                        </select>
                                                    </td>
                                                </tr>
                                            </tbody>
                                            <tfoot>
                                                <tr>
                                                    <td colspan="8">
                                                        <span>本週已排時數: {{ (parseFloat(form.time / 60)).toFixed(2) }} 小時</span>
                                                        <button class="btn btn-primary" @click="addShiftData()">新增</button>
                                                    </td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                </div>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="collapse" id="editShift">
                                <div class="card card-body">
                                    <h5>{{month.startDay}} ~ {{month.endDay}}(第{{month.week}}週)<span><button class="btn btn-outline-secondary" id="previousWeek" @click="previousWeek">&lt;</button><button class="btn btn-outline-secondary" id="nextWeek" @click="nextWeek">&gt;</button></span></h5>
                                    <div class="editForm">
                                        <table class="table table-bordered">
                                            <thead>
                                                <tr><th>員工</th><th v-for="d in form.data">{{d.date}} {{ d.day }}</th></tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td>
                                                        <select class="form-control" v-model="updateform.employee_id" @change="selectEditData()">
                                                            <option value="0">請選擇</option>
                                                            <option v-for="e in employee_in_shift" :value="e.employee_id">{{e.name}}</option>
                                                        </select>
                                                    </td>
                                                    <td v-for="(d,index) in updateform.data">
                                                        <select class="form-control" v-model="updateform.data[index].shift.shift_id" @change="changeEditShift(index)" :disabled="checkClosedDate(d.date)">
                                                            <option value="0">休假</option>
                                                            <option v-for="s in shift" :value="s.shift_id">{{s.shift_name}}</option>
                                                        </select>
                                                        <select class="form-control" v-model="updateform.data[index].position.position_id" @change="changeEditPosition(index)" :disabled="checkClosedDate(d.date)">
                                                            <option value="0">請選擇</option>
                                                            <option v-for="p in position" :value="p.position_id">{{p.name}}</option>
                                                        </select>
                                                    </td>
                                                </tr>
                                            </tbody>
                                            <tfoot>
                                                <tr>
                                                    <td colspan="8">
                                                        <span>本週已排時數: {{ (parseFloat(updateform.time / 60)).toFixed(2) }} 小時</span>
                                                        <button class="btn btn-primary" @click="updateShiftData()">更新</button>
                                                    </td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                </div>
                                </div>
                            </div>
                        </div>
                    </div>

                     <!-- calendar -->
                    <div  id="page">
                        <div class="page">
                            <nav>
                              <h1 class="date"></h1>
                              <div class="controls">
                                <button class="btn btn-outline-secondary" id="previousMonth" @click="previousMonth">&lt;</button>
                                <button class="btn btn-outline-secondary" id="nextMonth" @click="nextMonth">&gt;</button>
                              </div>
                            </nav>
                            <table>
                                <thead>
                                    <tr><td><div class="space">&nbsp;</div></td></tr>
                                </thead>
                                <tbody>
                                    <tr><td><div class="calendar"></div></td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal -->
        <div class="modal fade" id="copyModal" tabindex="-1" role="dialog" aria-labelledby="copyModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="copyModalLabel">複製排班</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="col-md-12 text-center">
                            <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist" style="display: inline-flex;">
                                <li class="nav-item" @click="Switch(0)">
                                    <a class="nav-link active" id="pills-1-tab" data-toggle="pill" href="#pills-1" role="tab" aria-controls="pills-1" aria-selected="true">整體班表複製</a>
                                </li>
                                <li class="nav-item" @click="Switch(1)">
                                    <a class="nav-link" id="pills-2-tab" data-toggle="pill" href="#pills-2" role="tab" aria-controls="pills-2" aria-selected="false">個別班表複製</a>
                                </li>
                            </ul>
                        </div>
                        <div class="tab-content" id="pills-tabContent">
                            <div class="tab-pane fade show active" id="pills-1" role="tabpanel" aria-labelledby="pills-1-tab">
                                <div class="form-group row" id="weekForm">
                                    <div class="col-12">
                                        <div class="alert alert-warning" role="alert">
                                            <strong>Tips:</strong>此功能主要是將某一週已經排完班的班表整體複製到其他週，由於<strong>首週</strong>與<strong>末週</strong>有天數不滿7天的限制所以不開放複製去其他週
                                        </div>
                                        <label for="account_number">將</label>
                                        <select name="week" id="" class="form-control"  v-model="weeksForm.startWeek">
                                            <option value="0">請選擇</option>
                                            <template v-for="(d,index) in weeks">
                                                <option v-if="filterCopy(index)" :value="d.startDay">{{d.startDay}}~{{d.endDay}}</option>
                                            </template>
                                            
                                        </select>
                                    </div>
                                    <div class="col-12">
                                        <label for="account_number">複製到</label>
                                        <select name="week" id="" class="form-control" v-model="weeksForm.endWeek">
                                            <option value="0">請選擇</option>
                                            <option :value="d.startDay" v-for="(d,index) in weeks" v-show="checkMulti(index)">{{d.startDay}}~{{d.endDay}}</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="pills-2" role="tabpanel" aria-labelledby="pills-2-tab">
                                <div class="form-group row" id="selfForm">
                                    <div class="col-12">
                                        <div class="alert alert-warning" role="alert">
                                            <strong>Tips:</strong>此功能主要是將某一週一位已經排好班員工的班表複製到該週其他員工上，被複製的員工<strong>必須在員工資料設定崗位才可以被選擇</strong>
                                        </div>
                                        <label for="week">週別</label>
                                        <select v-model="selfForm.startDay" @change="employeeSelfShift()" name="week" class="form-control">
                                            <option value="0">請選擇</option>
                                            <option :value="d.startDay" v-for="(d,index) in weeks" v-show="checkMulti(index)">{{d.startDay}}~{{d.endDay}}</option>
                                        </select>
                                    </div>
                                    <div class="col-12">
                                        <label for="employee">已排班員工</label>
                                        <select v-model="selfForm.employee_id" name="employee" class="form-control">
                                            <option value="0">請選擇</option>
                                            <option :value="e.employee_id" v-for="e in employee_in_shift_self">{{e.name}}</option>
                                        </select>
                                    </div>
                                    <div class="col-12">
                                        <label for="employee">目標員工</label>
                                        <div v-for="e in selfForm.employees" class="form-check" v-show="parseInt(e.employee_id) !== parseInt(selfForm.employee_id)">
                                            <input v-model="e.checked" value="e.employee_id" type="checkbox">
                                            <label for="checkbox">{{e.name}}</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" @click="copyAllShiftData()" v-show="copyType===0">送出</button>
                        <button type="button" class="btn btn-primary" @click="copySelfShiftData()" v-show="copyType===1">送出</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Modal END -->

        <!-- Modal -->
        <div class="modal right fade" id="statistic" tabindex="-1" role="dialog" aria-labelledby="statistic">
            <div class="modal-dialog" role="document">
                <div class="modal-content">

                <div class="modal-header">
                    <h4 class="modal-title" id="statistic">統計</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                </div>

                <div class="modal-body">
                   <table class="table table-hover" style="width: 100%;">
                       <thead>
                            <tr>
                                <th>姓名</th>
                                <th>總時數</th>
                                <th>總診數</th>
                            </tr>
                       </thead>
                       <tbody>
                           <tr v-for="(d,index) in calculateTable" @click="getCalculateTable(d.employee_id)" style="cursor: pointer;">
                               <td style="max-width: 70px;word-break: break-all;">{{ d.name }}</td>
                               <td>{{ (parseFloat(d.time.total_time) / 60).toFixed(1)  }}</td>
                               <td>{{ d.time.period }}</td>
                           </tr>
                       </tbody>
                   </table>
                </div>

                </div><!-- modal-content -->
            </div><!-- modal-dialog -->
        </div><!-- modal -->

        <!-- Modal -->
        <div class="modal fade" id="statistic2" tabindex="-1" role="dialog" aria-labelledby="statistic2">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">

                <div class="modal-header">
                    <h4 class="modal-title" id="statistic2">排班表統計</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                </div>

                <div class="modal-body">
                    <div style="text-align: center;">
                        <p>
                            <span>姓名: {{ calculateSelfTable.name }}  </span>
                            <span>總時數: {{ (parseFloat(calculateSelfTable.time.total_time) / 60).toFixed(1) }}  </span>
                            <span>總診數: {{ calculateSelfTable.time.period }}  </span>
                        </p>
                    </div>
                   <table class="table table-hover" style="width: 100%;">
                       <thead>
                            <tr>
                                <th>日期</th>
                                <th>星期</th>
                                <th>第一班</th>
                                <th>第二班</th>
                                <th>第三班</th>
                                <th>崗位</th>
                                <th>時數</th>
                                <th>診數</th>
                            </tr>
                       </thead>
                       <tbody>
                           <tr v-for="(d,index) in calculateSelfTable.shift_table" @click="getCalculateTable(d.employee_id)" style="cursor: pointer;">
                               <td>{{ d.date }}</td>
                               <td>{{ d.day }}</td>
                               <td>{{ d.shift.on_1st }} , {{ d.shift.off_1st }}</td>
                               <td>{{ d.shift.on_2nd }} , {{ d.shift.off_2nd }}</td>
                               <td>{{ d.shift.on_3rd }} , {{ d.shift.off_3rd }}</td>
                               <td>{{ d.position.name }}</td>
                               <td>{{ (parseFloat(d.shift.time) / 60).toFixed(1) }}</td>
                               <td>{{ d.shift.period }}</td>
                           </tr>
                       </tbody>
                   </table>
                </div>

                </div><!-- modal-content -->
            </div><!-- modal-dialog -->
        </div><!-- modal -->
  


        <iframe id="hidden-table" name="hidden-table" style="display: none;"></iframe>

    </div>



    <script src="../assets/js/loading.js"></script>
    <script src="../assets/js/jquery-3.4.1.min.js" ></script>
    <script src="../assets/js/q.js"></script>
    <script src="../assets/js/popper.min.js"></script>
    <script src="../assets/js/bootstrap.min.js"></script>
    <script src="../assets/js/vue.js"></script>
    <script src="../assets/js/week.js"></script>
    <script src="../assets/js/moment.js"></script>
    <script src="../assets/js/shift.js"></script>
    <script src="../assets/lib/dom.js"></script>
    <script src="../assets/lib/date.js"></script>
    <script src="../assets/lib/cal.js"></script>

    <script>
        //周
        // let w;
        //日曆
        // let calendar = 
        $(document).ready(function () {
            $('#sidebarCollapse').on('click', function () {
                $('#sidebar').toggleClass('active');
                $(this).toggleClass('active');
            });
            $("body").popover({
                selector: "[data-toggle='popover']",
                container: "body",
                html: true
            });
        });

        new Vue({
            el: "#app",
            data: {
                employee: [],
                shift: [],
                position: [],
                calculateTable: [],
                calculateSelfTable: {
                    employee_id: 0,
                    name: "",
                    time: {
                        period: 0,
                        total_time: 0
                    },
                    shift_table: []
                },
                month: {
                    month: "",
                    startDay: "",
                    endDay: "",
                    week: 0
                },
                form: {
                    employee_id: 0,
                    startDay: "",
                    endDay: "",
                    data:[],
                    time: 0
                },
                updateform: {
                    employee_id: 0,
                    startDay: "",
                    endDay: "",
                    data:[],
                    time: 0
                },
                shift_table: null,
                employee_in_shift:[],
                employee_not_in_shift: [],
                calendar:{},
                w:{},
                s:{},
                copyType:0,
                weeks: [],
                weeksForm:{
                    startWeek: "0",
                    endWeek: "0",
                },
                selfForm:{
                    startDay: 0,
                    employee_id: 0,
                    employees:[]
                },
                employee_in_shift_self: [],
                closed_date:[],
                user: {
                    user_id: 0,
                    account_number: '',
                    right: 0,
                    clinic_id: 0,
                    clinic_name:''
                },
            },
            created() {
                get('/api_v1.1/info?token='+window.localStorage.getItem('token')).then(res => {
                    if(res.code == 403) {
                        window.localStorage.removeItem('token')
                        location.href = './index.html'
                    } else {
                        this.user = res.data
                        this.getPosition_ShiftSettingData()
                        // this.getEmployeeData()
                        // this.getShiftSettingData()
                        //月份一更動(watch)，隨即調用排班 Cal Shift
                        this.month.month = new Date().Format('yyyy-MM')
                        this.copySelect()
                        // this.getClosedDateData()
                    }
                })
            },
            mounted() {
                //iframe 建立boostrap css
                let link = document.createElement("link") 
                link.href = "../assets/css/bootstrap.min.css"; 
                link.rel = "stylesheet"; 
                link.type = "text/css";
                window.frames['hidden-table'].document.head.appendChild(link);

                let link2 = document.createElement("link") 
                link2.href = "../assets/css/google.font.css"; 
                link2.rel = "stylesheet"; 
                link2.type = "text/css";
                window.frames['hidden-table'].document.head.appendChild(link2);
                
                
                const style = "@page { size:  auto; margin: 10px 5px; }body {margin: 0 5px;font-family: Arial;font-size: 10px;}.page{min-height:100vh;display:flex;flex-direction:column}.page>nav:first-child{text-align:right;display:flex;justify-content:space-between;align-items:center;padding:1em}.calendar{flex-grow:1;display:flex;flex-direction:column;min-width:1200px;}.calendar>ol{list-style:none;margin:0;padding:0}.calendar>ol.weekdays{display:flex;text-align:center;border-top:1px solid #c7c7cc}.calendar>ol.weekdays>li{width:14.2857%;padding:.5em 1em;border-right:1px solid #c7c7cc}.calendar>ol.weekdays>li:nth-child(1){border-left:1px solid #c7c7cc}.calendar>ol.days{display:flex;flex-wrap:wrap;flex-grow:1}.calendar>ol.days>li{width:14.2857%;border-right:1px solid #c7c7cc;border-top:1px solid #c7c7cc;min-height:200px;position:relative}.calendar>ol.days>li:nth-child(7n+1){border-left:1px solid #c7c7cc}.calendar>ol.days>li:nth-last-child(1),.calendar>ol.days>li:nth-last-child(2),.calendar>ol.days>li:nth-last-child(3),.calendar>ol.days>li:nth-last-child(4),.calendar>ol.days>li:nth-last-child(5),.calendar>ol.days>li:nth-last-child(6),.calendar>ol.days>li:nth-last-child(7){border-bottom:1px solid #C7C7CC}.calendar>ol.days>li>.dayLabel{position:absolute;left:.6em;top:.6em;white-space:nowrap;text-align:right}.calendar .today .day{background:red;width:1.6em;display:inline-block;text-align:center;height:1.6em;line-height:1.6em;border-radius:50%;color:#fff}.calendar>ol.days>li>.dayLabel>.day,.calendar>ol.days>li>.dayLabel>.unit{font-weight:700}.calendar .days .nextMonth,.calendar .days .previousMonth{color:#c3c3c3}.calendar .days .nextMonth>.shift_content,.calendar .days .previousMonth>.shift_content{background-color:transparent}.calendar>ol.days>li>.shift{position:absolute;top:.6em;left:3em;width:70%;text-align:center}.calendar>ol.days>li>.shift_n{position:absolute;top:2.4em;left:.6em;width:30%;height:75%}.calendar>ol.days>li>.shift_content{position:absolute;top:2.4em;left:3em;width:70%;height:75%;padding:0 .5em}.calendar>ol.days>li>.shift>.shift_type{width:25%;padding:0 3%;margin:0 6%;text-align:center}.calendar>ol.days>li>.shift_content>.employee{background-color:#eee !important;overflow:hidden;white-space:nowrap;text-overflow:clip;margin:0 0 .3em 0;text-align:center}.calendar>ol.days>li>.shift_n>.shift_name{margin:0 0 .3em 0}.calendar>ol.days>li>.shift_content>.employee.morning.night>.m>span,.calendar>ol.days>li>.shift_content>.employee.morning.night>.n>span,.calendar>ol.days>li>.shift_content>.employee>span,.calendar>ol.days>li>.shift_n>.shift_name>span{font-size: 13px;line-height: 24px;}.calendar>ol.days>li>.shift_content>.employee.morning{width:33.34%}.calendar>ol.days>li>.shift_content>.employee.afternoon{width:33.34%;margin-left:33.34%}.calendar>ol.days>li>.shift_content>.employee.night{margin-left:66.66%;width:33.34%}.calendar>ol.days>li>.shift_content>.employee.morning.afternoon{margin-left:0;width:66.67%}.calendar>ol.days>li>.shift_content>.employee.afternoon.night{width:66.67%;margin-left:33.34%}.calendar>ol.days>li>.shift_content>.employee.morning.night{background-color:transparent;margin-left:0;width:100%}.calendar>ol.days>li>.shift_content>.employee.morning.night>.m{background-color:#eee !important;overflow:hidden;white-space:nowrap;margin-left:0;width:33.4%;display:inline-block}.calendar>ol.days>li>.shift_content>.employee.morning.night>.n{background-color:#eee !important;overflow:hidden;white-space:nowrap;margin-left:30%;width:33.4%;display:inline-block}.calendar>ol.days>li>.shift_content>.employee.morning.afternoon.night{background-color:#eee !important;margin-left:0;width:100%}nav>h1.date{text-align:center;}nav>.controls{display:none;}.calendar,ol.days{display:block;page-break-inside:avoid !important;}body{-webkit-print-color-adjust:exact;}nav{position:fixed;top:5;right:50%;transform: translateX(50%);height:70px;}.space{height:70px;}ol{list-style:none; margin:0; padding:0; }ol.weekdays{display: flex; text-align: center; border-top: 1px solid #C7C7CC;}ol.weekdays >li{width: 14.2857%; padding: .5em 1em; border-right: 1px solid #C7C7CC;}ol.weekdays >li:nth-child(1){border-left: 1px solid #C7C7CC;} .calendar > ol.weekdays{display:none;}"
                let link3 = document.createElement("style")
                link3.appendChild(document.createTextNode(style));
                window.frames['hidden-table'].document.head.appendChild(link3);

                $('.modal').on('show.bs.modal', function(event) {
                var idx = $('.modal:visible').length;
                    $(this).css('z-index', 1040 + (10 * idx));
                });
                $('.modal').on('shown.bs.modal', function(event) {
                    var idx = ($('.modal:visible').length) -1; // raise backdrop after animation.
                    $('.modal-backdrop').not('.stacked').css('z-index', 1039 + (10 * idx));
                    $('.modal-backdrop').not('.stacked').addClass('stacked');
                });
            },
            methods: {
                logout() {
                    get('/api_v1.1/logout').then(res => {
                        if (res.code === 200) {
                            window.localStorage.removeItem('token')
                            alert('success')
                            location.href = './index.html'
                            return
                        }
                        else {
                            alert(res.message)
                        }
                    })
                },
                async getShiftTableData(month = "", week = "") {
                    //處理三大筆資料 employee shift closed_date 
                    const res = await get('/api_v1.1/clinic/new/shift?month='+this.month.month)
                    this.shift_table = res.data[0]
                    this.employee = res.data[1]
                    let tmp_data = []
                    res.data[2][0].forEach(d => {
                        tmp_data.push({
                            date: new Date(new Date(d.date).setDate(d.day)).Format("yyyy-MM-dd")
                        })
                    })
                    this.closed_date = tmp_data
                    if(month == "") {
                        this.getFirstWeekOfMonth()
                    } else {
                        this.getFirstWeekOfMonth(month)
                    }
                    if(week !== "") {
                        for (let i = 1; i < week; i++) {
                            this.nextWeek();
                        }
                    }
                    this.calculateTime()
                    this.shiftOnCalendar()
                },
                // async getEmployeeData(date = null) {
                //     const res = await get('/api_v1.1/clinic/new/shift/employee?start='+date)
                //     this.employee = res.data
                // },
                getPosition_ShiftSettingData() {
                    get('/api_v1.1/clinic/shift/setting/position').then(res => {
                        //處理shift data
                        let tmp = res.data[0]
                        tmp.forEach(item => {
                            let time = 0
                            for (let prop in item) {   
                                if (item[prop] === null || item[prop] === "") {
                                    delete item[prop];
                                }
                                if(prop === 'time_1st' || prop === 'time_2nd' || prop === 'time_3rd') {
                                    time = time + parseInt(item[prop])
                                    delete item[prop];
                                }
                            }
                            item['time'] = time
                        })
                        this.shift = tmp
                        this.position = res.data[1]
                    })
                },
                // getPositionData() {
                //     get('/api_v1.1/clinic/position').then(res => {
                //         if(res.code == 403) {
                //             location.href = './index.html'
                //         } else {
                //             this.position = res.data
                //         }
                //     })
                // },
                // getClosedDateData() {
                //     get('/api_v1.1/clinic/closed_date?date='+this.month.month).then(res => {
                //         if(res.code == 200) {
                //             let data = []
                //             res.data[0].forEach(d => {
                //                 data.push({
                //                     date: new Date(new Date(d.date).setDate(d.day)).Format("yyyy-MM-dd")
                //                 })
                //             })
                //             this.closed_date = data
                //         }
                //     })
                // },
                checkClosedDate(date) {
                    return this.closed_date.find(item => item.date == date) !== undefined
                },
                //剛進頁面初始化數值為當月1日
                getFirstWeekOfMonth(month = "") {
                    if(month != "") {
                        this.w = new Week(new Date(month).setDate(1))
                        this.month.month = new Date(month).Format("yyyy-MM")
                    } else {
                        this.w = new Week(new Date().setDate(1))
                        this.month.month = new Date().Format("yyyy-MM")
                    }
                    
                    const current = this.w.getCurrentWeek();
                    this.month.startDay = new Date(current[0].Date).Format("yyyy-MM-dd")
                    this.month.endDay = new Date(current[6].Date).Format("yyyy-MM-dd")
                    
                    this.filterMonth(current);
                    this.employeeShift()
                    this.month.week = 1
                    //防止第一週沒有員工可新增和編輯
                    this.$nextTick()
                },
                // 下一週
                nextWeek() {
                    if(this.month.week >= 4) {
                        const current = this.w.nextWeek();
                        if(new Date(current[0].Date).Format("yyyy-MM") == this.month.month) {
                            this.month.startDay = new Date(current[0].Date).Format("yyyy-MM-dd")
                            this.month.endDay = new Date(current[6].Date).Format("yyyy-MM-dd")
                            
                            this.filterMonth(current);
                            this.employeeShift()

                            if(this.month.week < 6) {
                                this.month.week = this.month.week+1
                            }
                        } else {
                            this.w.previousWeek()
                        }
                    } else {
                        const current = this.w.nextWeek();
                        this.month.startDay = new Date(current[0].Date).Format("yyyy-MM-dd")
                        this.month.endDay = new Date(current[6].Date).Format("yyyy-MM-dd")
                        
                        this.filterMonth(current);
                        this.employeeShift()

                        this.month.week = this.month.week+1
                    }
                },
                // 上一週
                previousWeek() {
                    if(this.month.week > 1 ) {
                        const current = this.w.previousWeek();
                        this.month.startDay = new Date(current[0].Date).Format("yyyy-MM-dd")
                        this.month.endDay = new Date(current[6].Date).Format("yyyy-MM-dd")
                        
                        this.filterMonth(current);
                        this.employeeShift()

                        this.month.week = this.month.week-1
                    }
                },
                //下個月
                nextMonth() {
                    let m = new Date(this.month.month)
                    let new_month = m.getMonth()+1
                    if(new_month == 12) {
                        let tmp = new Date().setFullYear(m.getFullYear() + 1,0, 1)
                        // this.getEmployeeData(new Date(tmp).Format("yyyy-MM")+'-01')
                        this.month.month = new Date(tmp).Format("yyyy-MM")
                    } else {
                        let newM = m.setMonth(new_month, 1)
                        // this.getEmployeeData(new Date(newM).Format("yyyy-MM"+'-01'))
                        this.month.month = new Date(newM).Format("yyyy-MM")
                    }
                    this.weeks = []
                    this.copySelect()
                },
                //上個月
                previousMonth() {
                    let m = new Date(this.month.month)
                    let new_month = m.getMonth()-1
                    if(new_month == -1) {
                        let tmp = new Date().setFullYear(m.getFullYear() - 1,11, 1)
                        // this.getEmployeeData(new Date(tmp).Format("yyyy-MM"+'-01'))
                        this.month.month = new Date(tmp).Format("yyyy-MM")
                    } else {
                        let newM = m.setMonth(new_month, 1)
                        // this.getEmployeeData(new Date(newM).Format("yyyy-MM"+'-01'))
                        this.month.month = new Date(newM).Format("yyyy-MM")
                    }
                    this.weeks = []
                    this.copySelect()
                },
                getDay() {
                    if(month != "") {
                        this.w = new Week(new Date(month).setDate(1))
                        this.month.month = new Date(month).Format("yyyy-MM")
                    } else {
                        this.w = new Week(new Date().setDate(1))
                        this.month.month = new Date().Format("yyyy-MM")
                    }
                    
                    const current = this.w.getCurrentWeek();
                    this.month.startDay = new Date(current[0].Date).Format("yyyy-MM-dd")
                    this.month.endDay = new Date(current[6].Date).Format("yyyy-MM-dd")
                    this.month.week = 1
                },
                filterMonth(current) {
                    this.form.data = []
                    this.updateform.data = []
                    current.forEach(item => {
                        const date = new Date(item.Date).Format("yyyy-MM-dd")
                        if(this.month.month == date.slice(0, 7)) {
                            this.form.data.push({
                                date: date, 
                                day: item.Day,
                                shift: {
                                    shift_id: 0,
                                    shift_name: "休假",
                                    time: 0
                                },
                                position: {
                                    position_id: 0,
                                    name: "請選擇",
                                }
                            })
                        }
                    })
                    this.form.time = 0
                    this.form.startDay = this.form.data[0].date
                    this.form.endDay = this.form.data[this.form.data.length - 1].date
                    this.updateform = JSON.parse(JSON.stringify(this.form))
                },
                changeShift(index) {
                    //依據shift_id更改shift的內容
                    const shift_id = this.form.data[index].shift.shift_id
                    if(shift_id == 0) {
                        this.form.data[index].shift = {
                            shift_id: 0,
                            shift_name: "休假",
                            time: 0
                        }
                        this.form.data[index].position = {
                            position_id: 0,
                            name: "請選擇"
                        }
                    } else {
                        let shift = this.shift.find(data => data.shift_id == shift_id)
                        delete shift["break_1st"]
                        delete shift["break_2nd"]
                        delete shift["break_3rd"]
                        this.form.data[index].shift = JSON.parse(JSON.stringify(shift))
                    }

                    //獲取所有時數
                    let total_time = 0
                    this.form.data.forEach(data => {
                        total_time = total_time + data.shift.time
                    })
                    // this.form.period = this.form.data[index].period
                    this.form.time = total_time
                },
                changePosition(index) {
                    //依據position_id更改position的內容
                    const position_id = this.form.data[index].position.position_id
                    if(position_id == 0) {
                        this.form.data[index].position = {
                            position_id: 0,
                            name: "請選擇"
                        }
                    } else {
                        const position = this.position.find(data => data.position_id == position_id)
                        this.form.data[index].position = JSON.parse(JSON.stringify(position))
                    }
                },
                changeEditPosition(index) {
                    //依據position_id更改position的內容
                    const position_id = this.updateform.data[index].position.position_id
                    if(position_id == 0) {
                        this.updateform.data[index].position = {
                            position_id: 0,
                            name: "請選擇"
                        }
                    } else {
                        const position = this.position.find(data => data.position_id == position_id)
                        this.updateform.data[index].position = JSON.parse(JSON.stringify(position))
                        // console.log(position)
                    }
                },
                employeeShift() {
                    //該週已排班員工
                    const startDay = this.form.startDay
                    this.employee_not_in_shift = []
                    this.employee_in_shift = []
                    let _in = []
                    let _not_in = []
                    if(this.shift_table !== null) {
                        const data = this.shift_table.filter(data => data.startDay === startDay)

                        this.employee.forEach(item => {
                            if(data.find(d => d.employee_id == item.employee_id)) {
                                _in.push({employee_id: item.employee_id,name: item.name})
                            } else {
                                _not_in.push({employee_id: item.employee_id,name: item.name})
                            }
                        })
                    } else {
                        _not_in = JSON.parse(JSON.stringify(this.employee))
                    }

                    // 避免已離職員工還存在在表單中
                    let _new_not_in = [];
                    _not_in.forEach(item => {
                        const employee = this.employee.find(d => parseInt(d.employee_id) === parseInt(item.employee_id))
                        // 如果離職日小於startDay則不顯示
                        if((Date.parse(employee.leave_at)).valueOf() >= (Date.parse(this.month.startDay)).valueOf()) {
                            _new_not_in.push(item);
                        }
                    });

                    this.employee_not_in_shift = _new_not_in;
                    this.employee_in_shift = _in
                },
                selectEditData() {
                    if(this.updateform.employee_id != 0) {
                        const startDay = this.updateform.startDay
                        const data = this.shift_table.find(data => 
                            data.employee_id == this.updateform.employee_id
                            && data.startDay == startDay    
                        )
                        this.updateform.data = data.data
                        this.updateform.time = data.time
                        const e = this.employee.find(d => d.employee_id == this.updateform.employee_id)
                        this.updateform.nickname = e.nickname
                    }
                },
                selectAddData() {
                    if(this.form.employee_id != 0) {
                        //搜尋該員工，獲取positio_id
                        const e = this.employee.find(d => d.employee_id == this.form.employee_id)
                        this.form.nickname = e.nickname
                        if(parseInt(e.position_id) !== 0) {
                            //獲取該職位名稱
                            const p = this.position.find(d => d.position_id == e.position_id)
                            this.form.data.forEach(item => {
                                item.position.name = p.name
                                item.position.position_id = p.position_id 
                            })
                        }
                    } else {
                        this.form.data.forEach(item => {
                            item.position.name = "請選擇"
                            item.position.position_id = 0 
                        })
                    }
                },
                changeEditShift(index) {
                    //依據shift_id更改shift的內容
                    const shift_id = this.updateform.data[index].shift.shift_id
                    if(shift_id == 0) {
                        this.updateform.data[index].shift = {
                            shift_id: 0,
                            shift_name: "休假",
                            time: 0
                        }
                        this.updateform.data[index].position = {
                            position_id: 0,
                            name: "請選擇"
                        }
                    } else {
                        const shift = this.shift.find(data => data.shift_id == shift_id)
                        delete shift["break_1st"];
                        delete shift["break_2nd"];
                        delete shift["break_3rd"];
                        this.updateform.data[index].shift = JSON.parse(JSON.stringify(shift))
                    }

                    //獲取所有時數
                    let total_time = 0
                    this.updateform.data.forEach(data => {
                        total_time = total_time + data.shift.time
                    })
                    // this.updateform.period = this.updateform.data[index].period
                    this.updateform.time = total_time
                },
                checkPosition() {
                    if(this.form.data.find(item => item.position.position_id == 0 && item.shift.shift_id != 0)) {
                        return true
                    } else {
                        return false
                    }
                },
                checkEditPosition() {
                    if(this.updateform.data.find(item => item.position.position_id == 0 && item.shift.shift_id != 0)) {
                        return true
                    } else {
                        return false
                    }
                },
                addShiftData() {
                    if(this.form.employee_id === 0) {
                        alert('請選擇員工!')
                    } else if(this.checkPosition()) {
                        alert('請選擇崗位!')
                    } else {
                        post('/api_v1.1/clinic/new/shift/add', this.form).then(res => {
                            if (res.code === 200) {
                                alert(res.message)
                                // window.location.reload('./new_shift.html')
                                this.getShiftTableData(this.month.month, this.month.week)
                                this.form.employee_id = 0
                                this.calendar = new Calendar({
                                    element: document.querySelector('.calendar'),
                                    output: document.querySelector('.date'),
                                },this.month.month);
                                this.$nextTick();
                                return
                            }
                            else {
                                alert(res.message)
                            }
                        })
                    }
                },
                updateShiftData() {
                    if(this.updateform.employee_id === 0) {
                        alert('請選擇員工!')
                    } else if(this.checkEditPosition()) {
                        alert('請選擇崗位!')
                    } else {
                        post('/api_v1.1/clinic/new/shift/update', this.updateform).then(res => {
                            if (res.code === 200) {
                                alert(res.message)
                                this.getShiftTableData(this.month.month, this.month.week)
                                this.calendar = new Calendar({
                                    element: document.querySelector('.calendar'),
                                    output: document.querySelector('.date'),
                                },this.month.month);
                                this.$nextTick();
                                return
                            }
                            else {
                                alert(res.message)
                            }
                        })
                    }
                },
                shiftOnCalendar() {
                    this.s = {}
                    if(this.shift_table !== null) {
                        this.shift_table.forEach(item => {
                            const data = this.employee.find(d => d.employee_id == item.employee_id)
                            if(data !== undefined) {
                                item['nickname'] = data.nickname
                            }
                        })
                        // console.log(this.shift_table)
                        // 傳入Shift.js
                        this.s = new Shift(this.shift_table)
                        this.changeLiHeight()
                    }
                },
                Switch(type) {
                    if(this.copyType !== type) {
                        this.copyType = type
                    }
                },
                copySelect() {
                    //整週，獲取本月全部的週數
                    const w = new Week(new Date(this.month.month).setDate(1))
                    let current = w.getCurrentWeek();
                    let week = 1
                    this.weeks.push({
                        startDay: new Date(this.month.month).Format("yyyy-MM-01"),
                        endDay: new Date(current[6].Date).Format("yyyy-MM-dd"),
                        week: week
                    })
                    while(true) {
                        if(week >= 4) {
                            current = w.nextWeek();
                            if(new Date(current[0].Date).Format("yyyy-MM") == this.month.month) {
                                if(week < 6) {
                                    week = week+1
                                }
                                if(new Date(current[6].Date).Format("yyyy-MM") !== this.month.month) {
                                    this.weeks.push({
                                        startDay: new Date(current[0].Date).Format("yyyy-MM-dd"),
                                        endDay: new Date(this.month.month.slice(0, 4), this.month.month.slice(-2), 0).Format("yyyy-MM-dd"),
                                        week: week
                                    })
                                } else {
                                    this.weeks.push({
                                        startDay: new Date(current[0].Date).Format("yyyy-MM-dd"),
                                        endDay: new Date(current[6].Date).Format("yyyy-MM-dd"),
                                        week: week
                                    })
                                }

                            } else {
                                break;
                            }
                        } else {
                            current = w.nextWeek();
                            week += 1
                            this.weeks.push({
                                startDay: new Date(current[0].Date).Format("yyyy-MM-dd"),
                                endDay: new Date(current[6].Date).Format("yyyy-MM-dd"),
                                week: week
                            })
                        }
                    }
                },
                filterCopy(index) {
                    const n = parseInt(Math.abs(new Date(this.weeks[index].endDay) - new Date(this.weeks[index].startDay)) / 1000 / 60 / 60 / 24)
                    if(n == 6) {
                        return true
                    } else {
                        return false
                    }
                },
                checkMulti(index) {
                    if(this.weeksForm.startWeek !== "0") {
                        if(this.weeksForm.startWeek == this.weeks[index].startDay) {
                            return false
                        }
                    }
                    return true
                },
                copyAllShiftData() {
                    //整體整週
                    if(this.weeksForm.startWeek == "0" || this.weeksForm.endWeek == "0" 
                    || this.weeksForm.startWeek.slice(0,7) !== this.month.month || this.weeksForm.endWeek.slice(0,7) !== this.month.month) {
                        alert("請選擇日期!")
                    } else {
                        post('/api_v1.1/clinic/new/shift/copy/weeks', this.weeksForm).then(res => {
                            if (res.code === 200) {
                                alert(res.message)
                                $('#copyModal').modal('hide')
                                this.weeksForm = {
                                    startWeek: "0",
                                    endWeek: "0",
                                }
                                this.getShiftTableData(this.month.month, this.month.week)
                                this.calendar = new Calendar({
                                    element: document.querySelector('.calendar'),
                                    output: document.querySelector('.date'),
                                },this.month.month);
                                this.$nextTick();
                                return
                            }
                            else {
                                alert(res.message)
                            }
                        })
                    }
                },
                copySelfShiftData() {
                    //資料篩選
                    let postForm = JSON.parse(JSON.stringify(this.selfForm));
                    postForm.employees = postForm.employees.filter(d => d.checked === true);
                    //表單驗證
                    if(parseInt(postForm.startDay) === 0) {
                        alert("請選擇週別!");
                    } else if(parseInt(postForm.employee_id) === 0) {
                        alert("請選擇員工!");
                    } else if(postForm.employees.length === 0) {
                        alert("請勾選要複製的員工!");
                    } else {
                        //提交資料
                        post('/api_v1.1/clinic/new/shift/copy/self', postForm).then(res => {
                            if (res.code === 200) {
                                alert(res.message)
                                $('#copyModal').modal('hide')
                                this.selfForm = {startDay: 0,employee_id: 0,employees:[]};
                                this.getShiftTableData(this.month.month, this.month.week)
                                this.calendar = new Calendar({
                                    element: document.querySelector('.calendar'),
                                    output: document.querySelector('.date'),
                                },this.month.month);
                                this.$nextTick();
                                return
                            }
                            else {
                                alert(res.message)
                            }
                        })
                    }
                },
                changeLiHeight() {
                    //自動調整高度
                    //獲取總共幾個li，最少4個(28天)，最多6個(42天)
                    const w = $('ol.days > li').length / 7
                    //第j週
                    for(let j = 0; j < w; j++) {
                        let max = 5
                        //第i天
                        for(let i = 0; i < 7; i++) {
                            const childCount = $(`ol.days > li:nth(${7*j + i}) > .shift_content`).children().length
                            if(childCount > max ) {
                                // //調整高度
                                // //每多一筆+25px
                                // $(`ol.days > li:nth(${7*j + i})`).height(`${200 + (childCount - 5) * 28}px`)
                                //該週最大筆
                                max = childCount
                            }
                        }
                        for(let i = 0; i < 7; i++) {
                            $(`ol.days > li:nth(${7*j + i})`).height(`${200 + (max - 5) * 28}px`)
                        }
                    }
                },
                employeeSelfShift(reset = false) {
                    //清空selfForm
                    this.selfForm.employee_id = 0;
                    this.selfForm.employees = [];
                    if(reset) {
                        this.selfForm.startDay = 0;
                    }
                    //該週已排班員工
                    const startDay = this.selfForm.startDay;
                    if(parseInt(this.selfForm.startDay) === 0) {
                        this.employee_in_shift_self = []
                    } else {
                        let _in = []
                        if(this.shift_table !== null) {
                            const data = this.shift_table.filter(data => data.startDay === startDay)

                            this.employee.forEach(item => {
                                if(data.find(d => d.employee_id == item.employee_id)) {
                                    _in.push({employee_id: item.employee_id,name: item.name})
                                }
                            })
                        }

                        // 避免已離職員工還存在在表單中
                        this.employee.forEach(item => {
                            if((Date.parse(item.leave_at)).valueOf() >= (Date.parse(startDay)).valueOf()
                                && parseInt(item.position_id) !== 0) {

                                this.selfForm.employees.push({
                                    employee_id: item.employee_id,
                                    name: item.name,
                                    nickname: item.nickname,
                                    position_id: item.position_id,
                                    checked: false
                                });
                            }
                        });
                        this.employee_in_shift_self = _in;
                    }
                },
                printPDF() {
                    const printHTML = document.getElementById('page').innerHTML;
                    var win = window.frames['hidden-table'];
                    document.title = `${this.month.month} ${this.user.clinic_name}排班表`
                    // var win = window.open();
                    win.document.body.innerHTML = printHTML;
                    const ol = document.body.querySelector('div.calendar').firstChild
                    const node = ol.cloneNode(true)
                    document.getElementById('hidden-table').contentWindow.document.querySelector('thead').appendChild(node)
                    win.document.close();
                    win.print();
                    document.title = `排班表`
                },
                calculateTime() {
                    let data = []
                    this.employee.forEach(item => {
                        //獲取該員工所有shift table
                        const st = this.shift_table.filter(d => parseInt(d.employee_id) === parseInt(item.employee_id));
                        let temp = [], tempTime = 0, tempPeriod = 0;
                        st.forEach(item => {
                            item.data.forEach(item2 => {
                                if(parseInt(item2.shift.time) === 0) {
                                    //計算時間 診數
                                    tempTime += 0;
                                    tempPeriod+= 0;
                                } else {
                                    //計算時間 診數
                                    tempTime += parseInt(item2.shift.time);
                                    tempPeriod+= parseInt(item2.shift.period);
                                    //push shift table
                                    temp.push(item2);
                                }
                            }); 
                        });

                        //由小排到大
                        temp = ArraySort(temp, (a, b) => new Date(a.date) - new Date(b.date));

                        //整理
                        data.push({
                            employee_id: item.employee_id,
                            name: item.name,
                            time: {
                                period: tempPeriod,
                                total_time: tempTime
                            },
                            shift_table: temp
                        });
                    });

                    //由大排到小
                    data = ArraySort(data, (a, b) => a.time.total_time < b.time.total_time);

                    this.calculateTable = data;
                },
                sortTable() {
                    this.calculateTable = ArraySort(this.calculateTable, (a, b) => a.time.total_time < b.time.total_time);
                },
                getCalculateTable(employee_id) {
                    //獲取該員工資料
                    const st = this.calculateTable.find(d => parseInt(d.employee_id) === parseInt(employee_id));
                    //modal
                    this.calculateSelfTable = st;
                    
                    
                    $('#statistic2').modal();
                }
            },
            watch: {
                //input與calendar同步
                "month.month": {
                    // immediate: true,
                    handler: function() {
                        // this.getEmployeeData(this.month.month+'-01')
                        this.getShiftTableData(this.month.month)
                        this.calendar = new Calendar({
                            element: document.querySelector('.calendar'),
                            output: document.querySelector('.date'),
                        },this.month.month);
                        this.weeks = []
                        this.copySelect()
                        this.employeeSelfShift(true)
                        //顯示排班
                        // this.shiftOnCalendar()
                        // this.getClosedDateData()
                    }
                }
            }
        })
    </script>
</body>
</html>