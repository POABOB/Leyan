<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>每月薪資明細表</title>
    <link rel="stylesheet" href="../assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="../assets/css/loading.css">
    <link rel="stylesheet" href="../assets/css/google.font.css">
<link rel="stylesheet" href="../assets/css/style.css">
</head>
<body>
    <div class="loading-wrapper">
        <svg class="loading"><rect></rect></svg>
    </div>
    <div id='app'>
        <div class="wrapper"  >
            <!-- Sidebar -->
            <nav id="sidebar">
                <ul class="list-unstyled components">
                    <p>樂薪考勤系統 - <span v-text="user.clinic_name"></span></p>
                    <li><a href="./assistant.html">診所管理</a></li>
                    <li><a href="./employee.html">員工資料</a></li>
                    <li><a href="./closed_date.html">休診設定</a></li>
                    <li><a href="./position.html">崗位設定</a></li>
                    <li><a href="./shift_setting.html">班別設定</a></li>
                    <li v-show="user.right > 2"><a href="./salary_item.html">薪項名稱設定</a></li>
                    <li v-show="user.right > 2"><a href="./basic_salary.html">基本薪資設定</a></li></a></li>
                    <li><a href="./new_shift.html">新排班表</a></li>
                    <li><a href="./shift_record.html">打卡明細</a></li>
                    <li ><a href="./attendance_overtime.html">加班明細</a></li>
                    <li><a href="./attendance_record.html">出勤明細</a></li>
                    <li><a href="./attendance_statistic.html">出勤統計表</a></li>
                    <li class="active" v-show="user.right > 2"><a href="./salary_calculation.html">每月薪資明細表</a></li>
                </ul>
            </nav>

            <!-- Page Content -->
            <div id="content">
                <nav class="navbar navbar-expand-lg navbar-light bg-light">
                    <div class="container-fluid">

                        <button type="button" id="sidebarCollapse" class="navbar-btn">
                            <span></span>
                            <span></span>
                            <span></span>
                        </button>
                        <button class="btn btn-dark d-inline-block d-lg-none ml-auto" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                            <i class="fas fa-align-justify"></i>
                        </button>

                        <div class="collapse navbar-collapse" id="navbarSupportedContent">
                            <ul class="nav navbar-nav ml-auto">
                                <li class="nav-item">
                                    <a class="nav-link" href="#" @click="logout()">登出</a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </nav>
                <div>
                    <div class="col-12 col-lg-7">
                        <div class="input-group mb-3">
                            <input type="month" class="form-control" id="month" v-model="month">
                            <div class="input-group-append">
                                <button class="btn btn-outline-secondary" type="button" @click="getSalaryCalculationData()" >確認</button>
                            </div>
                            <button class="btn btn-primary" data-toggle="modal" data-target="#updateSalaryCalculation">資料統計</button>
                            <button class="btn btn-primary" data-toggle="modal" data-target="#printSalaryCalculation">資料列印</button>
                        </div>
                    </div>
                    <p>本月天數：{{detail.total_days}} 天　例假與國定假日天數：{{detail.closed_days}} 天　應工作總工時：{{detail.work_hours}} 小時</p>
                    <h3>正職</h3>
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th scope="col">#</th>
                                <th scope="col">姓名</th>
                                <th scope="col">固定薪</th>
                                <th scope="col">日薪</th>
                                <th scope="col">時薪</th>
                                <th scope="col">餐費津貼</th>
                                <th scope="col">超時(加班)費</th>
                                <th scope="col">伙食津貼</th>
                                <th scope="col" v-for="(d, index) in salary_item">{{d}}</th>
                                <th scope="col">勞保費</th>
                                <th scope="col">健保費</th>
                                <th scope="col">請假(扣全薪)</th>
                                <th scope="col">請假(扣半薪)</th>
                                <th scope="col">遲到</th>
                                <th scope="col">早退</th>
                                <th scope="col">應領金額</th>
                                <th scope="col">扣項金額</th>
                                <th scope="col">實領薪津</th>
                                <th scope="col">轉帳</th>
                                <th scope="col">現金</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="(d, index) in data_2" v-show="alreadyLeave(d.employee_id)">
                                <th scope="row">{{index+1}}</th>
                                <td><button data-toggle="modal" data-target="#editEmployee" class="btn btn-outline-secondary" type="button" data-toggle="modal" data-target="#showThisEmployee"  @click="showThisEmployeeData(d.salary_calculation_id)">{{d.name}}</button></td>
                                <td>{{d.calculation_data.fixed_salary}}</td>
                                <td>{{d.calculation_data.daily_wage.toFixed(2)}}</td>
                                <td>{{d.calculation_data.hourly_wage.toFixed(2)}}</td>
                                <td>{{d.calculation_data.meal_fee}}</td>
                                <td>{{d.calculation_data.over_time_fee}}</td>
                                <td>{{d.calculation_data.meal_times_fee}}</td>
                                <td v-for="(d1, index) in d.salary_item_data">{{d1.value}}</td>
                                <td>{{d.calculation_data.labor_fee}}</td>
                                <td>{{d.calculation_data.health_total_fee}}</td>
                                <td>{{d.calculation_data.leave_all_fee}}</td>
                                <td>{{d.calculation_data.leave_half_fee}}</td>
                                <td>{{d.calculation_data.late_fee}}</td>
                                <td>{{d.calculation_data.early_fee}}</td>
                                <td>{{d.calculation_data.add_item}}</td>
                                <td>{{d.calculation_data.minus_item}}</td>
                                <td>{{d.calculation_data.total_salary}}</td>
                                <td>{{d.calculation_data.ATM}}</td>
                                <td>{{d.calculation_data.cash}}</td>
                            </tr>
                            <tr v-show="data_2 == null || data_2.length < 1">
                                <td colspan="30" style="text-align: center;">無月薪結算</td>
                            </tr>
                        </tbody>
                    </table>
                    <h3>兼職</h3>
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th scope="col">#</th>
                                <th scope="col">姓名</th>
                                <th scope="col">時薪</th>
                                <th scope="col">總工時</th>
                                <th scope="col">薪津</th>
                                <th scope="col">餐費津貼</th>
                                <th scope="col">超時(加班)費</th>
                                <th scope="col">伙食津貼</th>
                                <th scope="col" v-for="(d, index) in salary_item">{{d}}</th>
                                <th scope="col">勞保費</th>
                                <th scope="col">健保費</th>
                                <th scope="col">請假(扣全薪)</th>
                                <th scope="col">請假(扣半薪)</th>
                                <th scope="col">遲到</th>
                                <th scope="col">早退</th>
                                <th scope="col">應領金額</th>
                                <th scope="col">扣項金額</th>
                                <th scope="col">實領薪津</th>
                                <th scope="col">轉帳</th>
                                <th scope="col">現金</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="(d, index) in data_1"  v-show="alreadyLeave(d.employee_id)">
                                <th scope="row">{{index+1}}</th>
                                <td><button data-toggle="modal" data-target="#editEmployee" class="btn btn-outline-secondary" type="button" data-toggle="modal" data-target="#showThisEmployee"  @click="showThisEmployeeData(d.salary_calculation_id)">{{d.name}}</button></td>
                                <td>{{d.calculation_data.hourly_wage.toFixed(2)}}</td>
                                <td>{{(parseFloat(d.statistic_data.total_time)).toFixed(2)}}</td>
                                <td>{{(d.calculation_data.hourly_wage * parseFloat(d.statistic_data.total_time)).toFixed(0)}}</td>
                                <td>{{d.calculation_data.meal_fee}}</td>
                                <td>{{d.calculation_data.over_time_fee}}</td>
                                <td>{{d.calculation_data.meal_times_fee}}</td>
                                <td v-for="(d1, index) in d.salary_item_data">{{d1.value}}</td>
                                <td>{{d.calculation_data.labor_fee}}</td>
                                <td>{{d.calculation_data.health_total_fee}}</td>
                                <td>{{d.calculation_data.leave_all_fee}}</td>
                                <td>{{d.calculation_data.leave_half_fee}}</td>
                                <td>{{d.calculation_data.late_fee}}</td>
                                <td>{{d.calculation_data.early_fee}}</td>
                                <td>{{d.calculation_data.add_item}}</td>
                                <td>{{d.calculation_data.minus_item}}</td>
                                <td>{{d.calculation_data.total_salary}}</td>
                                <td>{{d.calculation_data.ATM}}</td>
                                <td>{{d.calculation_data.cash}}</td>
                            </tr>
                            <tr v-show="data_1 == null || data_1.length < 1">
                                <td colspan="30" style="text-align: center;">無月薪結算</td>
                            </tr>
                        </tbody>
                    </table>
                    <div id="salary-table" style="display: none;">
                        <table>
                            <tr>
                                <td style="text-align:center;" colspan="3">
                                    <span>薪資表</span><br>
                                    <span>月份: </span><span class="year"></span><span> 年 </span><span class="month"></span><span> 月</span>
                                </td>
                            </tr>
                            <tr>
                                <td colspan="2">職位</td>
                                <td class="position"></td>
                            </tr>
                            <tr>
                                <td colspan="2">姓名</td>
                                <td class="name"></td>
                            </tr>
                            <!--    add     -->
                            <tr>
                                <td class="break" rowspan="11">應<br>領<br>薪<br>資<br>金<br>額</td>
                                <td class="keep clear" id="s1"></td>
                                <td class="keep clear" id="m1"></td>
                            </tr>
                            <tr>
                                <td class="keep" id="s2"></td>
                                <td class="keep" id="m2"></td>
                            </tr>
                            <tr>
                                <td class="keep" id="s3"></td>
                                <td class="keep" id="m3"></td>
                            </tr>
                            <tr>
                                <td class="keep" id="s4"></td>
                                <td class="keep" id="m4"></td>
                            </tr>
                            <tr>
                                <td class="keep" id="s5"></td>
                                <td class="keep" id="m5"></td>
                            </tr>
                            <tr>
                                <td class="keep" id="s6"></td>
                                <td class="keep" id="m6"></td>
                            </tr>
                            <tr>
                                <td class="keep" id="s7"></td>
                                <td class="keep" id="m7"></td>
                            </tr>
                            <tr>
                                <td class="keep" id="s8"></td>
                                <td class="keep" id="m8"></td>
                            </tr>
                            <tr>
                                <td class="keep" id="s9"></td>
                                <td class="keep" id="m9"></td>
                            </tr>
                            <tr>
                                <td class="keep" id="s10"></td>
                                <td class="keep" id="m10"></td>
                            </tr>
                            <tr>
                                <td id="s11">合計</td>
                                <td class="keep" id="m11"></td>
                            </tr>
                            <!--     minus    -->
                            <tr>
                                <td class="break" rowspan="10">應<br>扣<br>金<br>額</td>
                                <td class="keep" id="s12"></td>
                                <td class="keep" id="m12"></td>
                            </tr>
                            <tr>
                                <td class="keep" id="s13"></td>
                                <td class="keep" id="m13"></td>
                            </tr>
                            <tr>
                                <td class="keep" id="s14"></td>
                                <td class="keep" id="m14"></td>
                            </tr>
                            <tr>
                                <td class="keep" id="s15"></td>
                                <td class="keep" id="m15"></td>
                            </tr>
                            <tr>
                                <td class="keep" id="s16"></td>
                                <td class="keep" id="m16"></td>
                            </tr>
                            <tr>
                                <td class="keep" id="s17"></td>
                                <td class="keep" id="m17"></td>
                            </tr>
                            <tr>
                                <td class="keep" id="s18"></td>
                                <td class="keep" id="m18"></td>
                            </tr>
                            <tr>
                                <td class="keep" id="s19"></td>
                                <td class="keep" id="m19"></td>
                            </tr>
                            <tr>
                                <td class="keep" id="s20"></td>
                                <td class="keep" id="m20"></td>
                            </tr>
                            <tr>
                                <td id="s21">合計</td>
                                <td class="keep" id="m21"></td>
                            </tr>
                            <!--    total      -->
                            <tr>
                                <td colspan="2">實領金額</td>
                                <td class="total"></td>
                            </tr>
                            <tr>
                                <td colspan="2">匯款</td>
                                <td class="ATM"></td>
                            </tr>
                            <tr>
                                <td class="cashT" colspan="2">現金</td>
                                <td class="cash"></td>
                            </tr>
                            
                        </table>
                    </div>
                </div>

                <iframe id="hidden-table" name="hidden-table" style="display: none;"></iframe>
            </div>
        </div>

        <!-- UPDATE SalaryCalculation Modal -->
        <div class="modal fade" id="updateSalaryCalculation" tabindex="-1" role="dialog" aria-labelledby="updateSalaryCalculationLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="updateSalaryCalculationLabel">資料統計</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="month">統整月份</label>
                            <input type="month" class="form-control" id="month" v-model="month">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" @click="updateSalaryCalculationData()">送出</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- PRINT SalaryCalculation Modal -->
        <div class="modal fade" id="printSalaryCalculation" tabindex="-1" role="dialog" aria-labelledby="printSalaryCalculationLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="printSalaryCalculationLabel">資料列印</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <legend  style="font-size: 1rem;">列印類型</legend>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="type" id="radioType1" value="1" v-model="printType">
                                <label class="form-check-label" for="radioType1">薪資條(pdf)</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="type" id="radioType2" value="2" v-model="printType">
                                <label class="form-check-label" for="radioType2">薪資條(不含現金)(pdf)</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="type" id="radioType3" value="3"  v-model="printType">
                                <label class="form-check-label" for="radioType3">薪資條(csv)</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <legend  style="font-size: 1rem;">員工</legend>
                            <button @click="checkToggle()" type="button"  class="btn btn-link">全選/取消</button>
                            <div style="height:100%;max-height:200px;overflow-y:scroll;">
                                <div class="form-check" v-for="(d, index) in printForm">
                                    <input v-model="printForm[index].check" class="form-check-input check-all" type="checkbox" :value="d.employee_id">
                                    <label class="form-check-label" for="check" v-text="d.name"></label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" @click="printSalaryList()">送出</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- EDIT ATTENDANCE Modal -->
        <div class="modal fade" id="editEmployee" tabindex="-1" role="dialog" aria-labelledby="editEmployeeLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editEmployeeLabel">每月薪資明細</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <p>薪資月份：{{this.month}}　本月天數：{{detail.total_days}} 天　例假與國定假日天數：{{detail.closed_days}}天　應工作總工時：{{detail.work_days * 8}} 小時　應工作診數：{{detail.total_days * 2}} 診　 本月在職天數：<span style="color: salmon;">{{updateForm.statistic_data.work_days}}</span> 天</p>
                        <p></p>
                        <table class="table" id="editTable" style="table-layout: fixed;">
                            <tbody>
                                <th colspan="10" style="background-color:#ffe9d6">員工資料</th>
                                <tr>
                                    <th scope="row">姓名</th>
                                    <td>
                                        {{updateForm.name}}
                                    </td>
                                    <th scope="row">到職日</th>
                                    <td colspan="2">
                                        {{updateForm.work_at}}
                                    </td>
                                    <th scope="row">離職日</th>
                                    <td colspan="2">
                                        {{(updateForm.leave_at === '9999-12-31' ? '' : updateForm.leave_at)}}
                                    </td>
                                    <th scope="row">職務別</th>
                                    <td><span style="color: cornflowerblue;">{{(updateForm.level_of_position == 1) ? '兼職' : '正職'}}</span></td>
                                </tr>
                                <th colspan="8" style="background-color:#ffe9d6">加項薪資</th>
                                <th style="background-color:#ffe9d6">加項合計</th>
                                <td style="background-color:#ffe9d6">{{updateForm.calculation_data.add_item}}</td>
                                <tr align="right">
                                    <th scope="row">固定薪</th>
                                    <td>
                                        {{updateForm.calculation_data.fixed_salary}}
                                    </td>
                                    <th v-show="updateForm.level_of_position === '2'" scope="row">⊙底薪</th>
                                    <td v-show="updateForm.level_of_position === '2'">
                                        <input disabled type="number" class="form-control" v-model="updateForm.calculation_data.basic_salary">
                                    </td>
                                    <th v-show="updateForm.level_of_position === '2'" scope="row">日薪</th>
                                    <td  v-show="updateForm.level_of_position === '2'">
                                        {{updateForm.calculation_data.daily_wage.toFixed(2)}}
                                    </td>
                                    <th scope="row">時薪</th>
                                    <td>
                                        {{updateForm.calculation_data.hourly_wage.toFixed(2)}}
                                    </td>
                                    <th v-show="updateForm.level_of_position === '1'" scope="row">薪津</th>
                                    <td v-show="updateForm.level_of_position === '1'">
                                        {{(this.updateForm.calculation_data.hourly_wage * this.updateForm.statistic_data.total_time).toFixed(0)}}
                                    </td>
                                </tr>
                                <tr align="right">
                                    <th scope="row">❋餐費津貼</th>
                                    <td>
                                        <input @change="reComputeTotal('meal_fee', 'add', 0)" type="number" min="0" class="form-control" v-model="updateForm.calculation_data.meal_fee">
                                    </td>
                                </tr>
                                <!-- 獎金 -->
                                <tr align="right" v-for="(d, index) in updateForm.salary_item_data">
                                    <th scope="row" v-if="(index * 4)  < (updateForm.salary_item_data.length) && updateForm.salary_item_data[index * 4].addORminus == 1"><span v-show="updateForm.salary_item_data[index * 4].paid_way == 1">❋</span><span v-show="updateForm.salary_item_data[index * 4].is_daily_salary == 1">⊙</span>{{updateForm.salary_item_data[index * 4].salary_name}}</th>
                                    <td v-if="(index * 4) < (updateForm.salary_item_data.length)  && updateForm.salary_item_data[index * 4].addORminus == 1"><input @change="reComputeTotal('salary_item_'+(index * 4), 'add', updateForm.salary_item_data[index * 4].paid_way, updateForm.salary_item_data[index * 4].is_fixed, updateForm.salary_item_data[index * 4].is_daily_salary)" class="form-control" type="number" min="0" v-model="updateForm.salary_item_data[index * 4].value"></td>
                                    <th scope="row" v-if="(index * 4 + 1) < (updateForm.salary_item_data.length) && updateForm.salary_item_data[index * 4 + 1].addORminus == 1"><span v-show="updateForm.salary_item_data[index * 4 + 1].paid_way == 1">❋</span><span v-show="updateForm.salary_item_data[index * 4 + 1].is_daily_salary == 1">⊙</span>{{updateForm.salary_item_data[index * 4 + 1].salary_name}}</th>
                                    <td v-if="(index * 4 + 1) < (updateForm.salary_item_data.length)  && updateForm.salary_item_data[index * 4 + 1].addORminus == 1"><input @change="reComputeTotal('salary_item_'+(index * 4 + 1), 'add', updateForm.salary_item_data[index * 4 + 1].paid_way, updateForm.salary_item_data[index * 4 + 1].is_fixed, updateForm.salary_item_data[index * 4 + 1].is_daily_salary)" class="form-control" type="number" min="0" v-model="updateForm.salary_item_data[index * 4 + 1].value"></td>
                                    <th scope="row" v-if="(index * 4 + 2) < (updateForm.salary_item_data.length) && updateForm.salary_item_data[index * 4 + 2].addORminus == 1"><span v-show="updateForm.salary_item_data[index * 4 + 2].paid_way == 1">❋</span><span v-show="updateForm.salary_item_data[index * 4 + 2].is_daily_salary == 1">⊙</span>{{updateForm.salary_item_data[index * 4 + 2].salary_name}}</th>
                                    <td v-if="(index * 4 + 2) < (updateForm.salary_item_data.length)  && updateForm.salary_item_data[index * 4 + 2].addORminus == 1"><input @change="reComputeTotal('salary_item_'+(index * 4 + 2), 'add', updateForm.salary_item_data[index * 4 + 2].paid_way, updateForm.salary_item_data[index * 4 + 2].is_fixed, updateForm.salary_item_data[index * 4 + 2].is_daily_salary)" class="form-control" type="number" min="0" v-model="updateForm.salary_item_data[index * 4 + 2].value"></td>
                                    <th scope="row" v-if="(index * 4 + 3) < (updateForm.salary_item_data.length) && updateForm.salary_item_data[index * 4 + 3].addORminus == 1"><span v-show="updateForm.salary_item_data[index * 4 + 3].paid_way == 1">❋</span><span v-show="updateForm.salary_item_data[index * 4 + 3].is_daily_salary == 1">⊙</span>{{updateForm.salary_item_data[index * 4 + 3].salary_name}}</th>
                                    <td v-if="(index * 4 + 3) < (updateForm.salary_item_data.length) && updateForm.salary_item_data[index * 4 + 3].addORminus == 1"><input @change="reComputeTotal('salary_item_' +(index * 4 + 3), 'add', updateForm.salary_item_data[index * 4 + 3].paid_way, updateForm.salary_item_data[index * 4 + 3].is_fixed, updateForm.salary_item_data[index * 4 + 3].is_daily_salary)" class="form-control" type="number" min="0" v-model="updateForm.salary_item_data[index * 4 + 3].value"></td>
                                </tr>
                                <tr align="right">
                                    <th scope="row">超時分鐘</th>
                                    <td>
                                        {{updateForm.statistic_data.over_time}}
                                    </td>
                                    <th scope="row">超時費</th>
                                    <td>
                                        <input @change="reComputeTotal('over_time_fee', 'add')" type="number" class="form-control" v-model="updateForm.calculation_data.over_time_fee">
                                    </td>
                                    <th scope="row">加診診數</th>
                                    <td>
                                        {{updateForm.statistic_data.bonus_period}}
                                    </td>
                                    <th scope="row">加診費</th>
                                    <td>
                                        <input @change="reComputeTotal('bonus_period_fee', 'add')" type="number" class="form-control" v-model="updateForm.calculation_data.bonus_period_fee">
                                    </td>
                                </tr>
                                <tr align="right">
                                    <th scope="row">餐點補助次數</th>
                                    <td>
                                        {{updateForm.statistic_data.meal_times}}
                                    </td>
                                    <th scope="row">伙食津貼總計</th>
                                    <td>
                                        <input @change="reComputeTotal('meal_times_fee', 'add')" type="number" class="form-control" v-model="updateForm.calculation_data.meal_times_fee">
                                    </td>
                                </tr>
                                <th colspan="8" style="background-color:#ffe9d6">減項薪資</th>
                                <th style="background-color:#ffe9d6">減項合計</th>
                                <td style="background-color:#ffe9d6">{{updateForm.calculation_data.minus_item}}</td>
                                <tr align="right">
                                    <th scope="row">請假分鐘(扣全薪)</th>
                                    <td>
                                        {{updateForm.statistic_data.leave_all}}
                                    </td>
                                    <th scope="row">請假扣薪</th>
                                    <td>
                                        <input @change="reComputeTotal('leave_all_fee', 'minus')" type="number" class="form-control" v-model="updateForm.calculation_data.leave_all_fee">
                                    </td>
                                    <th scope="row">請假分鐘(扣半薪)</th>
                                    <td>
                                        {{updateForm.statistic_data.leave_half}}
                                    </td>
                                    <th scope="row">請假扣薪</th>
                                    <td>
                                        <input @change="reComputeTotal('leave_half_fee', 'minus')" type="number" class="form-control" v-model="updateForm.calculation_data.leave_half_fee">
                                    </td>
                                </tr>
                                <tr align="right">
                                    <th scope="row">遲到分鐘</th>
                                    <td>
                                        {{updateForm.statistic_data.late}}
                                    </td>
                                    <th scope="row">遲到扣薪</th>
                                    <td>
                                        <input @change="reComputeTotal('late_fee', 'minus')" type="number" class="form-control" v-model="updateForm.calculation_data.late_fee">
                                    </td>
                                    <th scope="row">早退分鐘</th>
                                    <td>
                                        {{updateForm.statistic_data.early}}
                                    </td>
                                    <th scope="row">早退扣薪</th>
                                    <td>
                                        <input @change="reComputeTotal('early_fee', 'minus')" type="number" class="form-control" v-model="updateForm.calculation_data.early_fee">
                                    </td>
                                </tr>
                                <tr align="right">
                                    <th scope="row">勞保費</th>
                                    <td>
                                        <input @change="reComputeTotal('labor_fee', 'minus')" type="number" class="form-control" v-model="updateForm.calculation_data.labor_fee">
                                    </td>
                                    <th scope="row">健保費</th>
                                    <td>
                                        <input @change="reComputeTotal('health_fee', 'minus')" type="number" class="form-control" v-model="updateForm.calculation_data.health_fee">
                                    </td>
                                    <th scope="row">眷屬人數</th>
                                    <td>
                                        {{updateForm.calculation_data.health_nums}}
                                    </td>
                                    <th scope="row">健保合計</th>
                                    <td>
                                        {{updateForm.calculation_data.health_total_fee}}
                                    </td>
                                </tr>
                                <!-- 獎金 -->
                                <tr align="right" v-for="(d, index) in updateForm.salary_item_data">
                                    <th scope="row" v-if="(index * 4)  < (updateForm.salary_item_data.length) && updateForm.salary_item_data[index * 4].addORminus == 0"><span v-show="updateForm.salary_item_data[index * 4].paid_way == 1">❋</span><span v-show="updateForm.salary_item_data[index * 4].is_daily_salary == 1">⊙</span>{{updateForm.salary_item_data[index * 4].salary_name}}</th>
                                    <td v-if="(index * 4) < (updateForm.salary_item_data.length)  && updateForm.salary_item_data[index * 4].addORminus == 0"><input @change="reComputeTotal('salary_item_'+(index * 4), 'minus', updateForm.salary_item_data[index * 4].paid_way, updateForm.salary_item_data[index * 4].is_fixed, updateForm.salary_item_data[index * 4].is_daily_salary)" class="form-control" type="number" min="0" v-model="updateForm.salary_item_data[index * 4].value"></td>
                                    <th scope="row" v-if="(index * 4 + 1) < (updateForm.salary_item_data.length) && updateForm.salary_item_data[index * 4 + 1].addORminus == 0"><span v-show="updateForm.salary_item_data[index * 4 + 1].paid_way == 1">❋</span><span v-show="updateForm.salary_item_data[index * 4 + 1].is_daily_salary == 1">⊙</span>{{updateForm.salary_item_data[index * 4 + 1].salary_name}}</th>
                                    <td v-if="(index * 4 + 1) < (updateForm.salary_item_data.length)  && updateForm.salary_item_data[index * 4 + 1].addORminus == 0"><input @change="reComputeTotal('salary_item_'+(index * 4 + 1), 'minus', updateForm.salary_item_data[index * 4 + 1].paid_way, updateForm.salary_item_data[index * 4 + 1].is_fixed, updateForm.salary_item_data[index * 4 + 1].is_daily_salary)" class="form-control" type="number" min="0" v-model="updateForm.salary_item_data[index * 4 + 1].value"></td>
                                    <th scope="row" v-if="(index * 4 + 2) < (updateForm.salary_item_data.length) && updateForm.salary_item_data[index * 4 + 2].addORminus == 0"><span v-show="updateForm.salary_item_data[index * 4 + 2].paid_way == 1">❋</span><span v-show="updateForm.salary_item_data[index * 4 + 2].is_daily_salary == 1">⊙</span>{{updateForm.salary_item_data[index * 4 + 2].salary_name}}</th>
                                    <td v-if="(index * 4 + 2) < (updateForm.salary_item_data.length)  && updateForm.salary_item_data[index * 4 + 2].addORminus == 0"><input @change="reComputeTotal('salary_item_'+(index * 4 + 2), 'minus', updateForm.salary_item_data[index * 4 + 2].paid_way, updateForm.salary_item_data[index * 4 + 2].is_fixed, updateForm.salary_item_data[index * 4 + 2].is_daily_salary)" class="form-control" type="number" min="0" v-model="updateForm.salary_item_data[index * 4 + 2].value"></td>
                                    <th scope="row" v-if="(index * 4 + 3) < (updateForm.salary_item_data.length) && updateForm.salary_item_data[index * 4 + 3].addORminus == 0"><span v-show="updateForm.salary_item_data[index * 4 + 3].paid_way == 1">❋</span><span v-show="updateForm.salary_item_data[index * 4 + 3].is_daily_salary == 1">⊙</span>{{updateForm.salary_item_data[index * 4 + 3].salary_name}}</th>
                                    <td v-if="(index * 4 + 3) < (updateForm.salary_item_data.length) && updateForm.salary_item_data[index * 4 + 3].addORminus == 0"><input @change="reComputeTotal('salary_item_' +(index * 4 + 3), 'minus', updateForm.salary_item_data[index * 4 + 3].paid_way, updateForm.salary_item_data[index * 4 + 3].is_fixed, updateForm.salary_item_data[index * 4 + 3].is_daily_salary)" class="form-control" type="number" min="0" v-model="updateForm.salary_item_data[index * 4 + 3].value"></td>
                                </tr>
                                <th colspan="8" style="background-color:#ffe9d6">薪資合計</th>
                                <th style="background-color:#ffe9d6">實領</th>
                                <td style="background-color:#ffe9d6">{{updateForm.calculation_data.total_salary}}</td>
                                <tr>
                                    <th scope="row" colspan="8"></th>
                                    <th scope="row">轉帳</th>
                                    <td >
                                        {{updateForm.calculation_data.ATM}}
                                    </td>
                                </tr>
                                <tr>
                                    <th scope="row" colspan="8"></th>
                                    <th scope="row">現金</th>
                                    <td >
                                        {{updateForm.calculation_data.cash}}
                                    </td>
                                </tr>
                                <tr>
                                    <th colspan="10" style="text-align: right;">
                                        <button class="btn btn-primary" @click="updateSelfSalaryCalculation()">重新整理</button>
                                        <button type="button" class="btn btn-primary" @click="updateThisEmployeeData()">更新</button>
                                    </th>
                                </tr>
                                <tr style="text-align: right;"><td  colspan="10">註：❋領現金、⊙日薪計算基準</td></tr>
                                  
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            

        </div>



    </div>



    <script src="../assets/js/loading.js"></script>
    <script src="../assets/js/jquery-3.4.1.min.js" ></script>
    <script src="../assets/js/q.js"></script>
    <script src="../assets/js/popper.min.js"></script>
    <script src="../assets/js/bootstrap.min.js"></script>
    <script src="../assets/js/vue.js"></script>
    <script src="../assets/js/moment.js"></script>
    <script>
        $(document).ready(function () {
            $('#sidebarCollapse').on('click', function () {
                $('#sidebar').toggleClass('active');
                $(this).toggleClass('active');
            });

        });

        new Vue({
            el: "#app",
            data: {
                data: [],
                data_1: [],
                data_2: [],
                month: '0000-00',
                updateForm: {
                    salary_calculation_id: 0,
                    name: "",
                    work_at: "0000-00-00",
                    leave_at: "0000-00-00",
                    level_of_position: "2",
                    salary_item_data: [],
                    statistic_data: {
                        bonus_period: 0,
                        early: 0,
                        late: 0,
                        leave_all: 0,
                        leave_half: 0,
                        leave_none: 0,
                        meal_times: 0,
                        no_record_times: 0,
                        over_time: 0,
                        period: 0,
                        total_time: 0,
                        work_days: 0
                    },
                    calculation_data: {
                        fixed_salary: 0,
                        daily_wage: 0,
                        hourly_wage: 0,
                        over_time_fee: 0,
                        bonus_period_fee: 0,
                        meal_times_fee: 0,
                        //減項
                        leave_all_fee: 0,
                        leave_half_fee: 0,
                        late_fee: 0,
                        early_fee: 0,
                        labor_fee: 0,
                        health_fee: 0,
                        health_nums: 0,
                        health_total_fee: 0,
                        //結果
                        add_item: 0,
                        minus_item: 0,
                        total_salary: 0,
                        ATM: 0,
                        cash: 0
                    }
                },
                detail: {
                    total_days: 0,
                    total_hours: 0,
                    work_days: 0,
                    work_hours: 0,
                    closed_days: 0,
                    closed_hours: 0
                },
                salary_item: [],
                oldUpdateForm: [],
                user: {
                    user_id: 0,
                    account_number: '',
                    right: 0,
                    clinic_id: 0,
                    clinic_name:''
                },
                work_status: [],
                employeePosition: [],
                printForm:[],
                printType: 1,
                checkAll: false,
                tableIndex: 1,
            },
            created() {
                get('/api_v1.1/info?token='+window.localStorage.getItem('token')).then(res => {
                    if(res.code == 403) {
                        window.localStorage.removeItem('token')
                        location.href = './index.html'
                    } else {
                        this.user = res.data
                        //判斷這本月
                        let m = new Date(new Date().Format("yyyy-MM"))
                        let newM = m.setMonth(m.getMonth() - 1, 1)
                        this.month = new Date(newM).Format("yyyy-MM")
                        //自動賦值，月初和月底
                        this.getSalaryCalculationData()
                    }
                })

                
            },
            methods: {
                logout() {
                    get('/api_v1.1/logout').then(res => {
                        if (res.code === 200) {
                            window.localStorage.removeItem('token')
                            alert('success')
                            location.href = './index.html'
                            return
                        }
                        else {
                            alert(res.message)
                        }
                    })
                },
                getClosedDate() {
                    get('/api_v1.1/clinic/closed_date?date='+this.month).then(res => {
                        if(res.code == 403) {
                            location.href = './index.html'
                        } else {
                            this.detail = res.data[1]
                        }
                    })
                },
                getSalaryCalculationData() {
                    get(`/api_v1.1/clinic/salary/calculation?start=${this.month}`).then(res => {
                        if(res.code == 403) {
                            location.href = './index.html'
                        } else {
                            this.data = res.data[0]
                            this.data_1 = res.data[0].filter(d => parseInt(d.level_of_position) === 1)
                            this.data_2 = res.data[0].filter(d => parseInt(d.level_of_position) === 2)
                            this.work_status = res.data[1]
                            this.salary_item = []
                            if(res.data[0].length > 0) {
                                res.data[0][0].salary_item_data.forEach(item => {
                                    this.salary_item.push(item.salary_name);
                                })
                            }
                            this.employeePosition = res.data[2]
                            this.getClosedDate()
                            // printForm
                            this.printForm = []
                            if(this.data.length > 0) {
                                this.data.forEach(item => {
                                    this.printForm.push({
                                        employee_id: item.employee_id,
                                        name: item.name,
                                        check: false
                                    });
                                });
                            }
                            
                        }
                    })
                },
                updateSalaryCalculationData() {
                    post(`/api_v1.1/clinic/salary/calculation/update?start=${this.month}`).then(res => {
                        if(res.code == 403) {
                            location.href = './index.html'
                        } else if(res.code == 200) {
                            alert('更新成功!')
                            window.location.reload('./salary_calculation.html')
                        }
                    })
                },
                showThisEmployeeData(salary_calculation_id) {
                    const data = this.data.find(d => d.salary_calculation_id == salary_calculation_id)
                    const work = this.work_status.find(d => d.employee_id == data.employee_id)
                    this.updateForm.salary_calculation_id = data.salary_calculation_id
                    this.updateForm.employee_id = data.employee_id
                    this.updateForm.name = data.name
                    this.updateForm.statistic_data = data.statistic_data
                    this.updateForm.salary_item_data = data.salary_item_data
                    this.updateForm.calculation_data = data.calculation_data
                    this.updateForm.work_at = work.work_at
                    this.updateForm.leave_at = work.leave_at
                    this.updateForm.level_of_position = data.level_of_position

                    this.setValue()
                },
                updateThisEmployeeData() {
                    let form = {}
                    form.salary_calculation_id = this.updateForm.salary_calculation_id
                    form.calculation_data = this.updateForm.calculation_data
                    form.salary_item_data = this.updateForm.salary_item_data
                    post(`/api_v1.1/clinic/salary/calculation/update/id`, form).then(res => {
                        if(res.code == 403) {
                            location.href = './index.html'
                        } else if(res.code == 200) {
                            alert('更新成功!')
                            $('#editEmployee').modal('hide')
                            this.$nextTick()
                        }
                    })
                },
                reComputeTotal(dataType = null, calType = 'add', paidWay = 0, isFixed = 0, isDailySalary = 0) {
                    //TODO 兼職全職方式不同
                    //正職
                    if(dataType.slice(0,11) === "salary_item") {
                        //獎金部份計算方式不同
                        if(parseInt(isDailySalary) === 1) {
                            ///正職
                            const difference = this.updateForm.salary_item_data[dataType.slice(-1)].value - this.oldUpdateForm.salary_item_data[dataType.slice(-1)].value
                            if(this.updateForm.level_of_position === "2") {
                                if(calType === 'add') {
                                    //要重新計算日薪，並且重算有時數的加減項
                                    this.updateForm.calculation_data.daily_wage = parseFloat(((this.updateForm.calculation_data.daily_wage * 30 + difference) /30).toFixed(2))
                                    this.updateForm.calculation_data.hourly_wage = parseFloat((this.updateForm.calculation_data.daily_wage / 8).toFixed(2))
                                } else {
                                    this.updateForm.calculation_data.daily_wage = parseFloat(((this.updateForm.calculation_data.daily_wage * 30 - difference) /30).toFixed(2))
                                    this.updateForm.calculation_data.hourly_wage = parseFloat((this.updateForm.calculation_data.daily_wage / 8).toFixed(2))
                                }
                                //加班
                                this.updateForm.calculation_data.over_time_fee = parseFloat((((this.updateForm.statistic_data.over_time / 60) * this.updateForm.calculation_data.hourly_wage * 1.34)).toFixed(0))
                                //請假
                                this.updateForm.calculation_data.leave_all_fee = parseFloat((((this.updateForm.statistic_data.leave_all / 60) * this.updateForm.calculation_data.hourly_wage)).toFixed(0))
                                this.updateForm.calculation_data.leave_half_fee = parseFloat((((this.updateForm.statistic_data.leave_half / 60) * this.updateForm.calculation_data.hourly_wage / 2)).toFixed(0))
                                //早退
                                this.updateForm.calculation_data.early_fee = parseFloat((((this.updateForm.statistic_data.early / 60) * this.updateForm.calculation_data.hourly_wage)).toFixed(0))
                                //遲到
                                this.updateForm.calculation_data.late_fee = parseFloat((((this.updateForm.statistic_data.late / 60) * this.updateForm.calculation_data.hourly_wage)).toFixed(0))
                                
                                //先計算日薪 * 天數
                                this.updateForm.calculation_data.add_item = parseFloat(this.updateForm.calculation_data.daily_wage * ((this.updateForm.statistic_data.work_days > 30) ? 30 : this.updateForm.statistic_data.work_days))
                                //foreach 薪項
                                this.updateForm.calculation_data.cash = 0
                                this.updateForm.calculation_data.minus_item = 0
                                this.updateForm.salary_item_data.forEach(item => {
                                    if(item.is_daily_salary === "0") {
                                        if(item.addORminus === "1") {
                                            //加項
                                            this.updateForm.calculation_data.add_item += parseInt(item.value)
                                            if(item.paid_way === "1") {
                                                //現金
                                                this.updateForm.calculation_data.cash += parseInt(item.value)
                                            }
                                        } else {
                                            //減項
                                            this.updateForm.calculation_data.minus_item += parseInt(item.value)
                                            if(item.paid_way === "1") {
                                                //現金
                                                this.updateForm.calculation_data.cash -= parseInt(item.value)
                                            }
                                        }
                                    } else {
                                        //日薪計算基準 現金 * 天數 不大於30天
                                        if(item.addORminus === "1") {
                                            if(item.paid_way === "1") {
                                                //現金
                                                this.updateForm.calculation_data.cash += parseFloat(((item.value / 30) * ((this.updateForm.statistic_data.work_days >= 30) ? 30 : this.updateForm.statistic_data.work_days)).toFixed(2))
                                            }
                                        } else {
                                            if(item.paid_way === "1") {
                                                //現金
                                                this.updateForm.calculation_data.cash -= parseFloat(((item.value / 30) * ((this.updateForm.statistic_data.work_days >= 30) ? 30 : this.updateForm.statistic_data.work_days)).toFixed(2))
                                            }
                                        }
                                    }
                                })

                                //加項
                                this.updateForm.calculation_data.add_item += this.updateForm.calculation_data.bonus_period_fee + this.updateForm.calculation_data.over_time_fee + this.updateForm.calculation_data.meal_times_fee

                                //減項
                                this.updateForm.calculation_data.minus_item += this.updateForm.calculation_data.leave_all_fee + this.updateForm.calculation_data.leave_half_fee + this.updateForm.calculation_data.late_fee + this.updateForm.calculation_data.early_fee + parseInt(this.updateForm.calculation_data.health_total_fee) + parseInt(this.updateForm.calculation_data.labor_fee)
                                
                                //總計
                                this.updateForm.calculation_data.add_item = (Math.round(this.updateForm.calculation_data.add_item))
                                this.updateForm.calculation_data.minus_item = (Math.round(this.updateForm.calculation_data.minus_item))
                                this.updateForm.calculation_data.cash = (Math.round(this.updateForm.calculation_data.cash))
                                this.updateForm.calculation_data.total_salary = this.updateForm.calculation_data.add_item - this.updateForm.calculation_data.minus_item
                                this.updateForm.calculation_data.ATM = this.updateForm.calculation_data.total_salary - this.updateForm.calculation_data.cash

                                //isfixed
                                if(parseInt(isFixed) === 1) {
                                    this.updateForm.calculation_data.fixed_salary += difference
                                }
                            } else {
                                //TODO兼職
                                if(calType === 'add') {
                                    // this.updateForm.calculation_data.daily_wage = parseFloat(((this.updateForm.calculation_data.daily_wage * 30 + ) /30).toFixed(2))
                                    this.updateForm.calculation_data.hourly_wage = parseFloat(((this.updateForm.calculation_data.hourly_wage * 240 + difference) / 240).toFixed(2))
                                } else {
                                    // this.updateForm.calculation_data.daily_wage = parseFloat(((this.updateForm.calculation_data.daily_wage * 30 - difference) /30).toFixed(2))
                                    this.updateForm.calculation_data.hourly_wage = parseFloat(((this.updateForm.calculation_data.hourly_wage * 240 - difference) / 240).toFixed(2))
                                }
                                //加班
                                this.updateForm.calculation_data.over_time_fee = parseFloat((((this.updateForm.statistic_data.over_time / 60) * this.updateForm.calculation_data.hourly_wage)).toFixed(0))
                                //請假
                                this.updateForm.calculation_data.leave_all_fee = parseFloat((((this.updateForm.statistic_data.leave_all / 60) * this.updateForm.calculation_data.hourly_wage)).toFixed(0))
                                this.updateForm.calculation_data.leave_half_fee = parseFloat((((this.updateForm.statistic_data.leave_half / 60) * this.updateForm.calculation_data.hourly_wage / 2)).toFixed(0))
                                //早退
                                this.updateForm.calculation_data.early_fee = parseFloat((((this.updateForm.statistic_data.early / 60) * this.updateForm.calculation_data.hourly_wage)).toFixed(0))
                                //遲到
                                this.updateForm.calculation_data.late_fee = parseFloat((((this.updateForm.statistic_data.late / 60) * this.updateForm.calculation_data.hourly_wage)).toFixed(0))
                                
                                //先計算日薪 * 天數
                                this.updateForm.calculation_data.add_item = parseFloat(this.updateForm.calculation_data.hourly_wage * this.updateForm.statistic_data.total_time)
                                //foreach 薪項
                                this.updateForm.calculation_data.cash = 0
                                this.updateForm.calculation_data.minus_item = 0
                                this.updateForm.salary_item_data.forEach(item => {
                                    if(item.is_daily_salary === "0") {
                                        if(item.addORminus === "1") {
                                            //加項
                                            this.updateForm.calculation_data.add_item += parseInt(item.value)
                                            if(item.paid_way === "1") {
                                                //現金
                                                this.updateForm.calculation_data.cash += parseInt(item.value)
                                            }
                                        } else {
                                            //減項
                                            this.updateForm.calculation_data.minus_item += parseInt(item.value)
                                            if(item.paid_way === "1") {
                                                //現金
                                                this.updateForm.calculation_data.cash -= parseInt(item.value)
                                            }
                                        }
                                    } else {
                                        //日薪計算基準 現金 * 天數 不大於30天
                                        if(item.addORminus === "1") {
                                            if(item.paid_way === "1") {
                                                //現金
                                                this.updateForm.calculation_data.cash += parseFloat(((item.value / 240) * this.updateForm.statistic_data.total_time).toFixed(2))
                                            }
                                        } else {
                                            if(item.paid_way === "1") {
                                                //現金
                                                this.updateForm.calculation_data.cash -= parseFloat(((item.value / 240) * this.updateForm.statistic_data.total_time).toFixed(2))
                                            }
                                        }
                                    }
                                })

                                //加項
                                this.updateForm.calculation_data.add_item += this.updateForm.calculation_data.bonus_period_fee + this.updateForm.calculation_data.over_time_fee + this.updateForm.calculation_data.meal_times_fee

                                //減項
                                this.updateForm.calculation_data.minus_item += this.updateForm.calculation_data.leave_all_fee + this.updateForm.calculation_data.leave_half_fee + this.updateForm.calculation_data.late_fee + this.updateForm.calculation_data.early_fee + parseInt(this.updateForm.calculation_data.health_total_fee) + parseInt(this.updateForm.calculation_data.labor_fee)
                                
                                //總計
                                this.updateForm.calculation_data.add_item = (Math.round(this.updateForm.calculation_data.add_item))
                                this.updateForm.calculation_data.minus_item = (Math.round(this.updateForm.calculation_data.minus_item))
                                this.updateForm.calculation_data.cash = (Math.round(this.updateForm.calculation_data.cash))
                                this.updateForm.calculation_data.total_salary = this.updateForm.calculation_data.add_item - this.updateForm.calculation_data.minus_item
                                this.updateForm.calculation_data.ATM = this.updateForm.calculation_data.total_salary - this.updateForm.calculation_data.cash

                                //isfixed
                                if(parseInt(isFixed) === 1) {
                                    this.updateForm.calculation_data.fixed_salary += difference
                                }
                            }                            
                        } else {
                            //跟一般的多fixed paidway
                            const difference = this.updateForm.salary_item_data[dataType.slice(-1)].value - this.oldUpdateForm.salary_item_data[dataType.slice(-1)].value
                            if(calType === 'add') {
                                this.updateForm.calculation_data.add_item += difference
                                this.updateForm.calculation_data.total_salary = this.updateForm.calculation_data.add_item - this.updateForm.calculation_data.minus_item
                                if(parseInt(paidWay) === 0) {
                                    //現金
                                    this.updateForm.calculation_data.ATM = this.updateForm.calculation_data.total_salary - this.updateForm.calculation_data.cash
                                } else {
                                    //轉帳
                                    this.updateForm.calculation_data.cash = this.updateForm.calculation_data.total_salary - this.updateForm.calculation_data.ATM
                                }
                                if(parseInt(isFixed) === 1) {
                                    this.updateForm.calculation_data.fixed_salary += difference
                                }
                            } else {
                                this.updateForm.calculation_data.minus_item += difference
                                this.updateForm.calculation_data.total_salary = this.updateForm.calculation_data.add_item - this.updateForm.calculation_data.minus_item
                                if(parseInt(paidWay) === 0) {
                                    //現金
                                    this.updateForm.calculation_data.ATM = this.updateForm.calculation_data.total_salary - this.updateForm.calculation_data.cash
                                } else {
                                    //轉帳
                                    this.updateForm.calculation_data.cash = this.updateForm.calculation_data.total_salary - this.updateForm.calculation_data.ATM
                                }
                                if(parseInt(isFixed) === 1) {
                                    this.updateForm.calculation_data.fixed_salary -= difference
                                }
                            }
                        }
                        console.log(dataType, calType, paidWay , isFixed, isDailySalary);
                    } else {
                        //該新值與舊值的差
                        const difference = this.updateForm.calculation_data[dataType] - this.oldUpdateForm.calculation_data[dataType]
                        if(calType === 'add') {
                            this.updateForm.calculation_data.add_item += difference
                            if(parseInt(paidWay) === 0) {
                                this.updateForm.calculation_data.cash += difference
                            }
                            this.updateForm.calculation_data.total_salary = this.updateForm.calculation_data.add_item - this.updateForm.calculation_data.minus_item
                            this.updateForm.calculation_data.ATM = this.updateForm.calculation_data.total_salary - this.updateForm.calculation_data.cash
                            //現金互扣運算
                            if(this.updateForm.calculation_data.ATM < 0 && this.updateForm.calculation_data.total_salary > 0) {
                                this.updateForm.calculation_data.ATM = 0
                                this.updateForm.calculation_data.cash = this.updateForm.calculation_data.total_salary
                            }else if(this.updateForm.calculation_data.total_salary < 0) {
                                this.updateForm.calculation_data.ATM = this.updateForm.calculation_data.total_salary
                                this.updateForm.calculation_data.cash = 0
                            }
                        } else {
                            //健保計算方式特別
                            if(dataType === 'health_fee') {
                                const rate = (this.oldUpdateForm.calculation_data.health_total_fee) != 0 ? parseFloat(this.oldUpdateForm.calculation_data.health_total_fee / this.oldUpdateForm.calculation_data.health_fee) : 1
                                this.updateForm.calculation_data.health_total_fee = parseInt(this.updateForm.calculation_data.health_total_fee) + parseInt((difference * rate).toFixed(0))
                                this.updateForm.calculation_data.minus_item += parseInt((difference * rate).toFixed(0))
                                this.updateForm.calculation_data.total_salary = this.updateForm.calculation_data.add_item - this.updateForm.calculation_data.minus_item
                                this.updateForm.calculation_data.ATM = this.updateForm.calculation_data.total_salary - this.updateForm.calculation_data.cash
                            } else {
                                this.updateForm.calculation_data.minus_item += difference
                                this.updateForm.calculation_data.total_salary = this.updateForm.calculation_data.add_item - this.updateForm.calculation_data.minus_item
                                this.updateForm.calculation_data.ATM = this.updateForm.calculation_data.total_salary - this.updateForm.calculation_data.cash
                            }
                        }
                    }
                    //兼職
                    this.setValue()
                },
                setValue() {
                    this.oldUpdateForm = JSON.parse(JSON.stringify(this.updateForm))
                },
                alreadyLeave(employee_id) {
                    const work = this.work_status.find(d => d.employee_id == employee_id)
                    if((Date.parse(new Date(this.month).Format('yyyy-MM-01'))).valueOf() <= (Date.parse(work.leave_at)).valueOf()) {
                        return true
                    } else {
                        return false
                    }
                },
                updateSelfSalaryCalculation() {
                    //重整個人薪資
                    let form = {}
                    form.employee_id = this.updateForm.employee_id
                    post(`/api_v1.1/clinic/salary/self/calculation/update?start=${this.month}`, form).then(res => {
                        if(res.code == 403) {
                            location.href = './index.html'
                        } else if(res.code == 200) {
                            alert('重整成功!')
                            this.updateForm.calculation_data = res.data[0]
                            this.updateForm.salary_item_data = res.data[1]
                            $('#editEmployee').modal('hide')
                            this.$nextTick()
                        }
                    })
                },
                checkToggle() {
                    if(this.checkAll === false) {
                        this.printForm.forEach(item => {
                            item.check = true;
                        })
                    } else {
                        this.printForm.forEach(item => {
                            item.check = false;
                        })
                    }
                    this.checkAll = !this.checkAll
                },
                printSalaryList() {
                    //月份確認
                    const year = this.month.slice(0, 4);
                    const month = this.month.slice(-2);
                    
                    if(parseInt(this.printType) <= 2) {
                        let printHTML = ``;
                        document.querySelector('.year').textContent = year;
                        document.querySelector('.month').textContent = month;
                        if(parseInt(this.printType) === 1) {
                            //pdf all
                            this.data.forEach(item => {
                                const printData = this.printForm.find(d => d.employee_id === item.employee_id)
                                if(printData.check === true) {
                                    const e = this.employeePosition.find(d => d.employee_id === item.employee_id)
                                    //人 職位
                                    document.querySelector('.position').textContent = e.position;
                                    document.querySelector('.name').textContent = item.name;
                                    //固定加項
                                    this.tableIndex = 1;
                                    //判斷兼職 正職
                                    if(parseInt(item.level_of_position) === 2) {
                                        this.addItemToColumn('基本薪資', Math.round(parseInt(item.calculation_data.basic_salary) / 30.0 * ((item.statistic_data.work_days >= 30) ? 30 : item.statistic_data.work_days)));
                                    } else {
                                        this.addItemToColumn('薪津', Math.round(item.calculation_data.hourly_wage * parseFloat(item.statistic_data.total_time)));
                                    }
                                    this.addItemToColumn('超時費', item.calculation_data.over_time_fee);
                                    this.addItemToColumn('加診費', item.calculation_data.bonus_period_fee);
                                    this.addItemToColumn('伙食津貼總計', item.calculation_data.meal_times_fee);
                                    this.addItemToColumn('餐費津貼', item.calculation_data.meal_fee ? item.calculation_data.meal_fee : 0);
                                    //非固定加項
                                    item.salary_item_data.forEach(item2 => {
                                        if(parseInt(item2.addORminus) === 1 && parseInt(item2.value) > 0) {
                                            if(parseInt(item2.is_daily_salary) === 1) {
                                                //日薪計算基準
                                                this.addItemToColumn(item2.salary_name, Math.round(parseInt(item2.value) / 30 * ((item.statistic_data.work_days >= 30) ? 30 : item.statistic_data.work_days)));
                                            } else {
                                                this.addItemToColumn(item2.salary_name, parseInt(item2.value));
                                            }
                                        }
                                    })
                                    
                                    this.tableIndex = 12;
                                    //固定減項
                                    this.addItemToColumn('請假扣薪', item.calculation_data.leave_all_fee + item.calculation_data.leave_half_fee);
                                    this.addItemToColumn('遲到扣薪', item.calculation_data.late_fee);
                                    this.addItemToColumn('早退扣薪', item.calculation_data.early_fee);
                                    this.addItemToColumn('健保費', item.calculation_data.health_total_fee);
                                    this.addItemToColumn('勞保費', item.calculation_data.labor_fee);
                                    //非固定減項
                                    item.salary_item_data.forEach(item2 => {
                                        if(parseInt(item2.addORminus) === 0 && parseInt(item2.value) > 0) {
                                            document.getElementById(`s${i}`).textContent = item2.salary_name;
                                            if(parseInt(item2.is_daily_salary) === 1) {
                                                //日薪計算基準
                                                document.getElementById(`m${i}`).textContent = this.three(Math.round(parseInt(item2.value) / 30 * ((item.statistic_data.work_days >= 30) ? 30 : item.statistic_data.work_days)));
                                            } else{
                                                document.getElementById(`m${i}`).textContent = this.three(parseInt(item2.value));
                                            }
                                            i++;
                                        }
                                    })
                                    //總計
                                    let add_diff = this.addItemFix(item);
                                    if(add_diff !== 0) {
                                        document.getElementById('m1').textContent = parseInt((document.getElementById('m1').textContent).replace(',', '')) + add_diff;
                                    }

                                    document.getElementById('m11').textContent = this.three(item.calculation_data.add_item);
                                    document.getElementById('m21').textContent = this.three(item.calculation_data.minus_item);
                                    document.querySelector('.total').textContent = this.three(item.calculation_data.total_salary);
                                    document.querySelector('.cash').textContent = this.three(item.calculation_data.cash);
                                    document.querySelector('.cash').style.display = 'table-cell';
                                    document.querySelector('.cashT').style.display = 'table-cell';
                                    document.querySelector('.ATM').textContent = this.three(item.calculation_data.ATM);
                                    //蒐集html
                                    printHTML += document.getElementById('salary-table').innerHTML;
                                    this.cleanTable();
                                }
                            });
                        } else {
                            //pdf ATM
                            this.data.forEach(item => {
                                const printData = this.printForm.find(d => d.employee_id === item.employee_id)
                                if(printData.check === true) {
                                    const e = this.employeePosition.find(d => d.employee_id === item.employee_id)
                                    //人 職位
                                    document.querySelector('.position').textContent = e.position;
                                    document.querySelector('.name').textContent = item.name;
                                    //固定加項
                                    this.tableIndex = 1;
                                    //判斷兼職 正職
                                    if(parseInt(item.level_of_position) === 2) {
                                        this.addItemToColumn('基本薪資', Math.round(parseInt(item.calculation_data.basic_salary) / 30.0 * ((item.statistic_data.work_days >= 30) ? 30 : item.statistic_data.work_days)));
                                    } else {
                                        this.addItemToColumn('薪津', Math.round(item.calculation_data.hourly_wage * parseFloat(item.statistic_data.total_time)));
                                    }
                                    this.addItemToColumn('超時費', item.calculation_data.over_time_fee);
                                    this.addItemToColumn('加診費', item.calculation_data.bonus_period_fee);
                                    this.addItemToColumn('伙食津貼總計', item.calculation_data.meal_times_fee);
                                    //非固定加項
                                    let cash_add = 0;
                                    cash_add += item.calculation_data.meal_fee ? parseInt(item.calculation_data.meal_fee) : 0;
                                    item.salary_item_data.forEach(item2 => {
                                        if(parseInt(item2.addORminus) === 1 && parseInt(item2.value) > 0  && parseInt(item2.paid_way) === 0) {
                                            if(parseInt(item2.is_daily_salary) === 1) {
                                                //日薪計算基準
                                                this.addItemToColumn(item2.salary_name, Math.round(parseInt(item2.value) / 30 * ((item.statistic_data.work_days >= 30) ? 30 : item.statistic_data.work_days)));
                                            } else {
                                                this.addItemToColumn(item2.salary_name, parseInt(item2.value));
                                            }
                                        } else if(parseInt(item2.addORminus) === 1 && parseInt(item2.value) > 0  && parseInt(item2.paid_way) === 1) {
                                            if(parseInt(item2.is_daily_salary) === 1) {
                                                //日薪計算基準
                                                cash_add += Math.round(parseInt(item2.value) / 30 * ((item.statistic_data.work_days >= 30) ? 30 : item.statistic_data.work_days));
                                            } else {
                                                cash_add += parseInt(item2.value);
                                            }
                                        }
                                    })
                                    
                                    this.tableIndex = 12;
                                    //固定減項
                                    this.addItemToColumn('請假扣薪', item.calculation_data.leave_all_fee + item.calculation_data.leave_half_fee);
                                    this.addItemToColumn('遲到扣薪', item.calculation_data.late_fee);
                                    this.addItemToColumn('早退扣薪', item.calculation_data.early_fee);
                                    this.addItemToColumn('健保費', item.calculation_data.health_total_fee);
                                    this.addItemToColumn('勞保費', item.calculation_data.labor_fee);
                                    //非固定減項
                                    let cash_minus = 0;
                                    item.salary_item_data.forEach(item2 => {
                                        if(parseInt(item2.addORminus) === 0 && parseInt(item2.value) > 0 && parseInt(item2.paid_way) === 0) {
                                            if(parseInt(item2.is_daily_salary) === 1) {
                                                //日薪計算基準
                                                this.addItemToColumn(item2.salary_name, Math.round(parseInt(item2.value) / 30 * ((item.statistic_data.work_days >= 30) ? 30 : item.statistic_data.work_days)));
                                            } else{
                                                this.addItemToColumn(item2.salary_name, parseInt(item2.value));
                                            }
                                        } else if(parseInt(item2.addORminus) === 0 && parseInt(item2.value) > 0  && parseInt(item2.paid_way) === 1) {
                                            if(parseInt(item2.is_daily_salary) === 1) {
                                                //日薪計算基準
                                                cash_minus += Math.round(parseInt(item2.value) / 30 * ((item.statistic_data.work_days >= 30) ? 30 : item.statistic_data.work_days));
                                            } else {
                                                cash_minus += parseInt(item2.value);
                                            }
                                        }
                                    })
                                    //總計
                                    let add_diff = this.addItemFix(item);
                                    if(add_diff !== 0) {
                                        document.getElementById('m1').textContent = parseInt((document.getElementById('m1').textContent).replace(',', '')) + add_diff;
                                    }

                                    document.getElementById('m11').textContent = this.three(item.calculation_data.add_item - cash_add);
                                    document.getElementById('m21').textContent = this.three(item.calculation_data.minus_item - cash_minus);
                                    document.querySelector('.total').textContent = this.three(item.calculation_data.total_salary - item.calculation_data.cash);
                                    document.querySelector('.cash').textContent = this.three(item.calculation_data.cash);
                                    document.querySelector('.cash').style.display = 'none';
                                    document.querySelector('.cashT').style.display = 'none';
                                    document.querySelector('.ATM').textContent = this.three(item.calculation_data.ATM);
                                    //蒐集html
                                    printHTML += document.getElementById('salary-table').innerHTML;
                                    this.cleanTable();
                                }
                            });
                        }
                        //打印
                        if(printHTML !== '') {
                            const style = "<style>@page { size:  auto; margin: 0 5px; }body {margin: 0 5px;font-family: Arial;font-size: 10px;}table {display:inline-block;border-collapse: collapse;max-width: 300px; margin-top:5px;margin-left:0;margin-right:2px;}table th {background-color: #fff;color: #333;font-weight: bold;}table th, table td {padding: 1px 5px;border: 1px solid #000;text-align: center;height:16px;}.keep {word-break: keep-all;}.break {word-break: break-all;}</style>"
                            var win = window.frames['hidden-table'];
                            win.document.write(`<!DOCTYPE html><html><head><title>薪資條</title>${style}</head><body>${printHTML}</body></html>`);
                            win.document.close();
                            win.print();
                        } else {
                            alert('請選擇員工!');
                        }
                    } else {
                        //csv all
                        let data = [];
                        //正職標題
                        let FT = ['姓名', '基本薪資', '超時費', '加診費', '伙食津貼總計', '伙食津貼'];
                        this.salary_item.forEach(item => {
                            FT.push(item);   
                        })
                        FT = FT.concat(['勞保費', '健保費', '請假', '遲到', '早退', '應領金額', '扣項金額', '實領薪津', '轉帳', '現金']);
                        data.push(['正職'],FT);

                        this.data.forEach(item => {
                            const printData = this.printForm.find(d => d.employee_id === item.employee_id)
                            if(printData.check === true) {
                                if(parseInt(item.level_of_position) === 2){
                                    let tmp_data = []
                                    // const e = this.employeePosition.find(d => d.employee_id === item.employee_id)
                                    tmp_data.push(item.name);
                                    //加項
                                    tmp_data.push(Math.round(parseInt(item.calculation_data.basic_salary) / 30.0 * ((item.statistic_data.work_days >= 30) ? 30 : item.statistic_data.work_days)));
                                    tmp_data.push(item.calculation_data.over_time_fee);
                                    tmp_data.push(item.calculation_data.bonus_period_fee);
                                    tmp_data.push(item.calculation_data.meal_times_fee);
                                    tmp_data.push(item.calculation_data.meal_fee ? item.calculation_data.meal_fee : 0);
                                    //薪項
                                    item.salary_item_data.forEach(item2 => {
                                        if(parseInt(item2.is_daily_salary) === 1) {
                                            //日薪計算基準
                                            tmp_data.push(Math.round(parseInt(item2.value) / 30 * ((item.statistic_data.work_days >= 30) ? 30 : item.statistic_data.work_days)));
                                        } else {
                                            tmp_data.push(parseInt(item2.value));
                                        }
                                    })
                                    //減項
                                    tmp_data.push(item.calculation_data.labor_fee);
                                    tmp_data.push(item.calculation_data.health_total_fee);
                                    tmp_data.push(item.calculation_data.leave_all_fee + item.calculation_data.leave_half_fee);
                                    tmp_data.push(item.calculation_data.late_fee);
                                    tmp_data.push(item.calculation_data.early_fee);
                                    //總計
                                    tmp_data.push(item.calculation_data.add_item);
                                    tmp_data.push(item.calculation_data.minus_item);
                                    tmp_data.push(item.calculation_data.total_salary);
                                    tmp_data.push(item.calculation_data.ATM);
                                    tmp_data.push(item.calculation_data.cash);

                                    //diff
                                    let add_diff = this.addItemFix(item);
                                    if(add_diff !== 0) {
                                        for(let i = 1; i < tmp_data.length; i++) {
                                            if(parseInt(tmp_data[i]) > 0) {
                                                tmp_data[i] = tmp_data[i] + add_diff;
                                                break;
                                            }
                                        }
                                    }
                                    data.push(tmp_data);
                                }
                            }
                        });
                        
                        //兼職標題
                        FT[1] = '薪津';
                        data.push([],['兼職'], FT);
                        //兼職員工
                        this.data.forEach(item => {
                            const printData = this.printForm.find(d => d.employee_id === item.employee_id)
                            if(printData.check === true) {
                                if(parseInt(item.level_of_position) === 1) {
                                    let tmp_data = []
                                    // const e = this.employeePosition.find(d => d.employee_id === item.employee_id)
                                    tmp_data.push(item.name);
                                    //加項
                                    tmp_data.push(Math.round(item.calculation_data.hourly_wage * parseFloat(item.statistic_data.total_time)));
                                    tmp_data.push(item.calculation_data.over_time_fee);
                                    tmp_data.push(item.calculation_data.bonus_period_fee);
                                    tmp_data.push(item.calculation_data.meal_times_fee);
                                    tmp_data.push(item.calculation_data.meal_fee ? item.calculation_data.meal_fee : 0);
                                    //薪項
                                    item.salary_item_data.forEach(item2 => {
                                        if(parseInt(item2.is_daily_salary) === 1) {
                                            //日薪計算基準
                                            tmp_data.push(Math.round(parseInt(item2.value) / 30 * ((item.statistic_data.work_days >= 30) ? 30 : item.statistic_data.work_days)));
                                        } else {
                                            tmp_data.push(parseInt(item2.value));
                                        }
                                    })
                                    //減項
                                    tmp_data.push(item.calculation_data.labor_fee);
                                    tmp_data.push(item.calculation_data.health_total_fee);
                                    tmp_data.push(item.calculation_data.leave_all_fee + item.calculation_data.leave_half_fee);
                                    tmp_data.push(item.calculation_data.late_fee);
                                    tmp_data.push(item.calculation_data.early_fee);
                                    //總計
                                    tmp_data.push(item.calculation_data.add_item);
                                    tmp_data.push(item.calculation_data.minus_item);
                                    tmp_data.push(item.calculation_data.total_salary);
                                    tmp_data.push(item.calculation_data.ATM);
                                    tmp_data.push(item.calculation_data.cash);
                                    //diff
                                    let add_diff = this.addItemFix(item);
                                    if(add_diff !== 0) {
                                        for(let i = 1; i < tmp_data.length; i++) {
                                            if(parseInt(tmp_data[i]) > 0) {
                                                tmp_data[i] = tmp_data[i] + add_diff;
                                                break;
                                            }
                                        }
                                    }
                                    data.push(tmp_data);
                                }
                            }
                        });

                        this.exportCSV(data);
                    }
                },
                three(num) {
                    const parts = num.toString().split('.');
                    parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                    return parts.join('.');// '$' +
                },
                addItemToColumn(name = '', value = 0) {
                    if(parseInt(value) > 0) {
                        document.getElementById(`s${this.tableIndex}`).textContent = name;
                        document.getElementById(`m${this.tableIndex}`).textContent = this.three(value);
                        this.tableIndex++;
                    }
                },
                cleanTable() {
                    const td = document.getElementsByClassName('keep');
                    const tdLen = td.length;
                    for(let i = 0;i < tdLen;i++){
                        //將.kepp的text清空
                        td[i].textContent = '';
                    }

                    document.querySelector('.position').textContent = '';
                    document.querySelector('.name').textContent = '';
                    document.querySelector('.total').textContent = '';
                    document.querySelector('.cash').textContent = '';
                    document.querySelector('.ATM').textContent = '';
                },
                exportCSV(rows = [], filename = `${this.month} 薪資條.csv`) {
                    var processRow = function (row) {
                        var finalVal = '';
                        for (var j = 0; j < row.length; j++) {
                            var innerValue = row[j] === null ? '' : row[j].toString();
                            if (row[j] instanceof Date) {
                                innerValue = row[j].toLocaleString();
                            };
                            var result = innerValue.replace(/"/g, '""');
                            if (result.search(/("|,|\n)/g) >= 0)
                                result = '"' + result + '"';
                            if (j > 0)
                                finalVal += ',';
                            finalVal += result;
                        }
                        return finalVal + '\n';
                    };

                    var csvFile = '';
                    for (var i = 0; i < rows.length; i++) {
                        csvFile += processRow(rows[i]);
                    }

                    var blob = new Blob([csvFile], { type: 'text/csv;charset=utf-8;' });
                    if (navigator.msSaveBlob) { // IE 10+
                        navigator.msSaveBlob(blob, filename);
                    } else {
                        var link = document.createElement("a");
                        if (link.download !== undefined) { // feature detection
                            // Browsers that support HTML5 download attribute
                            var url = URL.createObjectURL(blob);
                            link.setAttribute("href", url);
                            link.setAttribute("download", filename);
                            link.style.visibility = 'hidden';
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                        }
                    }
                },
                addItemFix(item) {
                    let diff = 0;
                    //修正加項金額差額
                    if(parseInt(item.level_of_position) === 2) {
                        diff += Math.round(parseInt(item.calculation_data.basic_salary) / 30.0 * ((item.statistic_data.work_days >= 30) ? 30 : item.statistic_data.work_days)) + parseInt(item.calculation_data.over_time_fee) + parseInt(item.calculation_data.bonus_period_fee) + parseInt(item.calculation_data.meal_times_fee) + parseInt(item.calculation_data.meal_fee ? item.calculation_data.meal_fee : 0);
                    } else {
                        diff += Math.round(item.calculation_data.hourly_wage * parseFloat(item.statistic_data.total_time)) + parseInt(item.calculation_data.over_time_fee) + parseInt(item.calculation_data.bonus_period_fee) + parseInt(item.calculation_data.meal_times_fee) + parseInt(item.calculation_data.meal_fee ? item.calculation_data.meal_fee : 0);
                    }
                    //非固定加項
                    item.salary_item_data.forEach(item2 => {
                        if(parseInt(item2.addORminus) === 1 && parseInt(item2.value) > 0) {
                            if(parseInt(item2.is_daily_salary) === 1) {
                                //日薪計算基準
                                diff += Math.round(parseInt(item2.value) / 30 * ((item.statistic_data.work_days >= 30) ? 30 : item.statistic_data.work_days));
                            } else {
                                diff += parseInt(item2.value);
                            }
                        }
                    })
                    return parseInt(item.calculation_data.add_item - diff);
                },
            }
        })
    </script>
</body>
</html>